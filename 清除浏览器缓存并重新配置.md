# 清除浏览器缓存并重新配置 AI 服务

## 🐛 问题原因

后端日志显示仍在使用错误的 endpoint:
```
代理请求到阿里云百炼: https://bailian.aliyun.com/v1/api/completions
```

**原因**: 配置保存在浏览器的 localStorage 中,即使你修改了设置页面,旧的配置仍然存在。

---

## ✅ 解决方案

### 方法 1: 清除浏览器缓存 (推荐)

#### Chrome / Edge 浏览器

1. **打开开发者工具**
   - 按 `F12` 或 `Ctrl + Shift + I`

2. **打开 Application 标签**
   - 点击顶部的 "Application" 标签
   - 如果看不到,点击 `>>` 展开更多标签

3. **清除 Local Storage**
   - 左侧找到 "Storage" → "Local Storage"
   - 点击 `http://localhost:3000`
   - 右键点击空白处,选择 "Clear"
   - 或者点击右上角的 "Clear all" 按钮

4. **刷新页面**
   - 按 `Ctrl + F5` 强制刷新
   - 或者关闭开发者工具后刷新

#### Firefox 浏览器

1. **打开开发者工具**
   - 按 `F12`

2. **打开 Storage 标签**
   - 点击 "Storage" 标签

3. **清除 Local Storage**
   - 左侧找到 "Local Storage" → `http://localhost:3000`
   - 右键点击,选择 "Delete All"

4. **刷新页面**
   - 按 `Ctrl + F5`

---

### 方法 2: 使用浏览器控制台清除

1. **打开控制台**
   - 按 `F12` 打开开发者工具
   - 点击 "Console" 标签

2. **执行清除命令**
   ```javascript
   localStorage.clear()
   location.reload()
   ```

3. **页面会自动刷新**

---

### 方法 3: 手动删除特定配置

1. **打开控制台** (`F12` → Console)

2. **查看当前配置**
   ```javascript
   console.log(localStorage.getItem('llm_config'))
   ```

3. **删除 LLM 配置**
   ```javascript
   localStorage.removeItem('llm_config')
   localStorage.removeItem('llm_api_key')
   localStorage.removeItem('llm_endpoint')
   location.reload()
   ```

---

## 🚀 重新配置步骤

清除缓存后,按以下步骤重新配置:

### 1. 刷新页面

访问 http://localhost:3000 并刷新

### 2. 打开设置页面

点击右上角的 **设置图标** ⚙️

### 3. 填写正确的配置

**API Key**:
```
sk-3a6fcd7c0b04482d8bc3596725520d18
```

**API Endpoint** (重要!):
```
https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
```

**注意**: 
- ✅ 使用 `dashscope.aliyuncs.com` 域名
- ❌ 不要使用 `bailian.aliyun.com` 域名

### 4. 保存配置

点击 **"保存配置"** 按钮

### 5. 测试

点击 **"测试 AI 对话"** 按钮

**预期结果**:
```
✅ 测试成功
AI 服务配置正确
```

---

## 🔍 验证配置是否正确

### 方法 1: 查看浏览器控制台

1. 打开控制台 (`F12` → Console)
2. 执行:
   ```javascript
   console.log(localStorage.getItem('llm_endpoint'))
   ```
3. 应该看到:
   ```
   https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
   ```

### 方法 2: 查看后端日志

```powershell
docker-compose logs backend -f
```

**正确的日志**:
```
[时间] 代理请求到阿里云百炼: https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
[时间] 阿里云API响应成功
```

**错误的日志** (如果还是这样,说明配置没清除):
```
[时间] 代理请求到阿里云百炼: https://bailian.aliyun.com/v1/api/completions
[时间] 阿里云API错误: { status: 404, statusText: 'Not Found', error: {} }
```

---

## 📸 截图示例

### 正确的设置页面

应该看到:

```
┌─────────────────────────────────────────────────────┐
│ LLM 配置                                             │
├─────────────────────────────────────────────────────┤
│                                                      │
│ API Key ⓘ                                           │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 🔑 sk-3a6fcd7c0b04482d8bc3596725520d18         │ │
│ └─────────────────────────────────────────────────┘ │
│                                                      │
│ API Endpoint ⓘ                                      │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 🔑 https://dashscope.aliyuncs.com/api/v1/...   │ │
│ └─────────────────────────────────────────────────┘ │
│                                                      │
│ ✅ 正确示例: https://dashscope.aliyuncs.com/...    │
│ 💡 获取方式: [查看文档]                             │
│                                                      │
│ [ 保存配置 ]  [ 测试 AI 对话 ]                      │
└─────────────────────────────────────────────────────┘
```

---

## ❓ 常见问题

### Q1: 清除缓存后需要重新登录吗?

**A**: 是的,清除 localStorage 会删除所有本地数据,包括登录状态。你需要重新登录。

### Q2: 清除缓存会丢失我的旅行计划吗?

**A**: 不会。旅行计划保存在 Supabase 数据库中,不会因为清除浏览器缓存而丢失。重新登录后可以看到所有数据。

### Q3: 我已经清除缓存了,但还是 404 错误?

**A**: 请检查:
1. 是否真的清除了 localStorage (在控制台执行 `localStorage.length` 应该返回 0)
2. 是否刷新了页面 (`Ctrl + F5`)
3. 是否重新填写了正确的 Endpoint
4. 查看后端日志确认使用的是哪个 endpoint

### Q4: 为什么 .env.local 文件中的配置不生效?

**A**: 因为:
1. `.env.local` 是前端构建时使用的环境变量
2. Docker 容器中的前端已经构建完成,不会读取 `.env.local`
3. 应用运行时的配置保存在浏览器 localStorage 中
4. 用户需要在设置页面手动配置

---

## 🎯 完整操作流程

```
1. 打开浏览器开发者工具 (F12)
   ↓
2. 打开 Console 标签
   ↓
3. 执行: localStorage.clear()
   ↓
4. 执行: location.reload()
   ↓
5. 页面刷新后,重新登录
   ↓
6. 点击设置图标 ⚙️
   ↓
7. 填写 API Key 和正确的 Endpoint
   ↓
8. 点击"保存配置"
   ↓
9. 点击"测试 AI 对话"
   ↓
10. 看到 ✅ 测试成功
```

---

## 📝 正确的配置值

**复制粘贴使用**:

```
API Key:
sk-3a6fcd7c0b04482d8bc3596725520d18

API Endpoint:
https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
```

---

**创建时间**: 2025-10-29  
**状态**: ✅ 解决方案已验证

