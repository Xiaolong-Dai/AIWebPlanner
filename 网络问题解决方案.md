# 🔧 Docker 网络问题解决方案

## 🐛 问题诊断

你遇到的错误是:
```
failed to fetch oauth token: Post "https://auth.docker.io/token": 
dial tcp 157.240.7.8:443: connectex: A connection attempt failed 
because the connected party did not properly respond after a period 
of time, or established connection failed because connected host has 
failed to respond.
```

**问题原因**: Docker 无法连接到 Docker Hub 下载镜像

**可能的原因**:
1. 网络连接问题
2. 防火墙阻止
3. DNS 解析问题
4. Docker Hub 在某些地区访问受限

---

## ✅ 解决方案

### 方案一: 配置 Docker 镜像加速器 (推荐)

使用国内的 Docker 镜像源可以解决访问问题。

#### 1. 打开 Docker Desktop 设置

1. 右键点击系统托盘的 Docker 图标
2. 选择 "Settings" (设置)
3. 选择 "Docker Engine"

#### 2. 添加镜像加速器配置

在配置文件中添加以下内容:

```json
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://docker.1panel.live",
    "https://hub.rat.dev"
  ],
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false
}
```

**注意**: 
- 如果配置文件中已有其他内容,只需添加 `"registry-mirrors"` 部分
- 保持 JSON 格式正确 (注意逗号)

#### 3. 应用并重启

1. 点击 "Apply & Restart" 按钮
2. 等待 Docker Desktop 重启完成 (约 30-60 秒)

#### 4. 验证配置

```powershell
docker info | Select-String "Registry Mirrors"
```

应该能看到配置的镜像地址。

---

### 方案二: 使用阿里云镜像加速器

如果你有阿里云账号,可以使用阿里云的专属镜像加速器:

#### 1. 获取加速器地址

1. 访问: https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors
2. 登录阿里云账号
3. 复制你的专属加速器地址 (格式: `https://xxxxxx.mirror.aliyuncs.com`)

#### 2. 配置 Docker

在 Docker Desktop 设置中添加:

```json
{
  "registry-mirrors": [
    "https://xxxxxx.mirror.aliyuncs.com"
  ]
}
```

替换 `xxxxxx` 为你的实际加速器地址。

---

### 方案三: 检查网络和防火墙

#### 1. 检查网络连接

```powershell
# 测试能否访问 Docker Hub
Test-NetConnection -ComputerName hub.docker.com -Port 443

# 测试 DNS 解析
nslookup hub.docker.com
```

#### 2. 检查防火墙

1. 打开 Windows 防火墙设置
2. 确保 Docker Desktop 被允许通过防火墙
3. 如果使用企业网络,联系网络管理员

#### 3. 检查代理设置

如果你使用代理上网:

1. 打开 Docker Desktop 设置
2. 选择 "Resources" → "Proxies"
3. 配置代理服务器地址

---

### 方案四: 手动下载镜像 (临时方案)

如果以上方案都不行,可以尝试手动拉取镜像:

```powershell
# 拉取 Node.js 镜像
docker pull node:18-alpine

# 拉取 Nginx 镜像
docker pull nginx:alpine
```

如果手动拉取也失败,说明网络问题比较严重,需要配置镜像加速器。

---

## 🚀 配置完成后重新部署

### 1. 重启 Docker Desktop

确保配置生效。

### 2. 清理缓存 (可选)

```powershell
# 清理构建缓存
docker builder prune -a

# 清理所有未使用的资源
docker system prune -a
```

### 3. 重新运行部署脚本

```powershell
.\docker-deploy.ps1
```

---

## 📋 推荐的镜像加速器列表

### 国内公共镜像源

| 镜像源 | 地址 | 说明 |
|--------|------|------|
| DaoCloud | https://docker.m.daocloud.io | 稳定可靠 |
| 1Panel | https://docker.1panel.live | 速度快 |
| Rat Dev | https://hub.rat.dev | 备用 |

### 云服务商镜像源

| 服务商 | 地址格式 | 获取方式 |
|--------|---------|---------|
| 阿里云 | https://xxxxxx.mirror.aliyuncs.com | 需要登录获取 |
| 腾讯云 | https://mirror.ccs.tencentyun.com | 公开可用 |
| 网易云 | https://hub-mirror.c.163.com | 公开可用 |

---

## 🔍 验证镜像加速器是否生效

### 1. 查看 Docker 配置

```powershell
docker info
```

在输出中查找 "Registry Mirrors" 部分,应该能看到配置的镜像地址。

### 2. 测试拉取镜像

```powershell
# 拉取一个小镜像测试
docker pull hello-world

# 查看拉取速度
docker pull node:18-alpine
```

如果速度明显提升,说明镜像加速器配置成功。

---

## ❓ 常见问题

### Q1: 配置镜像加速器后还是很慢?

**A**: 
1. 尝试更换其他镜像源
2. 检查网络连接质量
3. 尝试在网络较好的时段构建

### Q2: Docker Desktop 重启后配置丢失?

**A**: 
1. 确保点击了 "Apply & Restart"
2. 检查 JSON 格式是否正确
3. 以管理员身份运行 Docker Desktop

### Q3: 所有镜像源都无法访问?

**A**: 
1. 检查防火墙设置
2. 检查是否使用了代理
3. 联系网络管理员 (如果在企业网络)

---

## 📝 完整的 Docker Engine 配置示例

```json
{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false,
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://docker.1panel.live",
    "https://hub.rat.dev"
  ],
  "dns": [
    "8.8.8.8",
    "114.114.114.114"
  ],
  "insecure-registries": [],
  "debug": false,
  "log-level": "info"
}
```

---

## 🎯 下一步

1. ✅ 配置镜像加速器
2. ✅ 重启 Docker Desktop
3. ✅ 验证配置生效
4. ✅ 运行 `.\docker-deploy.ps1`
5. ✅ 等待构建完成

---

## 📞 需要帮助?

如果问题仍然存在:

1. 检查 Docker Desktop 日志
2. 查看系统事件查看器
3. 尝试重新安装 Docker Desktop
4. 检查网络连接和防火墙设置

---

**更新时间**: 2025-10-29  
**问题**: Docker 无法连接到 Docker Hub  
**解决方案**: 配置镜像加速器  
**状态**: ✅ 可解决

