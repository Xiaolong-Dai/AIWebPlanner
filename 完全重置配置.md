# 完全重置配置 - 彻底解决 AI 服务 404 问题

## 🎯 问题分析

根据后端日志,API 调用**已经成功**:
```
[2025-10-29T14:03:32.812Z] 代理请求到阿里云百炼: https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
[2025-10-29T14:03:34.602Z] 阿里云API响应成功 ✅
```

但你仍然看到错误,可能原因:
1. **浏览器缓存** - 显示的是旧的错误信息
2. **localStorage 配置** - 保存了错误的 endpoint
3. **前端代码缓存** - 浏览器缓存了旧的 JS 文件

---

## ✅ 完全重置方案 (5 分钟)

### 步骤 1: 清除所有浏览器数据

#### 方法 A: 使用无痕模式 (最简单)

1. **关闭当前浏览器标签页**
2. **打开无痕窗口**
   - Chrome/Edge: `Ctrl + Shift + N`
   - Firefox: `Ctrl + Shift + P`
3. **访问** http://localhost:3000
4. **重新注册/登录**
5. **配置 API**

#### 方法 B: 清除站点数据 (彻底)

**Chrome/Edge**:
1. 按 `F12` 打开开发者工具
2. 按 `F1` 打开设置
3. 找到 "Network" → "Disable cache (while DevTools is open)"
4. 勾选这个选项
5. 回到 Application 标签
6. 左侧找到 "Storage"
7. 点击 "Clear site data" 按钮
8. 刷新页面 (`Ctrl + Shift + R`)

**Firefox**:
1. 按 `F12` 打开开发者工具
2. 点击 "Storage" 标签
3. 右键点击 `http://localhost:3000`
4. 选择 "Delete All"
5. 刷新页面 (`Ctrl + Shift + R`)

### 步骤 2: 强制刷新前端容器

```powershell
# 停止容器
docker-compose down

# 清除前端镜像
docker rmi aiwebplanner-frontend

# 重新构建并启动
docker-compose up -d --build frontend

# 查看日志
docker-compose logs frontend -f
```

### 步骤 3: 重新配置

1. **访问** http://localhost:3000
2. **注册/登录**
3. **点击设置图标** ⚙️
4. **填写配置**:

   **API Key**:
   ```
   sk-3a6fcd7c0b04482d8bc3596725520d18
   ```

   **API Endpoint**:
   ```
   https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
   ```

5. **保存配置**
6. **测试 AI 对话**

---

## 🔍 验证配置

### 1. 检查 localStorage

打开控制台 (`F12` → Console):
```javascript
console.log('Endpoint:', localStorage.getItem('llm_endpoint'))
```

**应该看到**:
```
Endpoint: https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
```

### 2. 检查后端日志

```powershell
docker-compose logs backend -f
```

点击 "测试 AI 对话" 后,**应该看到**:
```
[时间] 代理请求到阿里云百炼: https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
[时间] 阿里云API响应成功
```

### 3. 检查网络请求

1. 打开 Network 标签 (`F12` → Network)
2. 点击 "测试 AI 对话"
3. 查找 `llm-proxy` 请求
4. 点击查看 Request Payload

**应该看到**:
```json
{
  "prompt": "你好",
  "systemPrompt": "你是一个专业的旅行规划助手...",
  "apiKey": "sk-3a6fcd7c0b04482d8bc3596725520d18",
  "endpoint": "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"
}
```

---

## 🚨 如果还是不行

### 检查 1: API Key 是否有效

在控制台执行:
```javascript
fetch('/api/llm-proxy', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    prompt: '你好',
    systemPrompt: '你是助手',
    apiKey: 'sk-3a6fcd7c0b04482d8bc3596725520d18',
    endpoint: 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation'
  })
})
.then(r => r.json())
.then(d => console.log('响应:', d))
.catch(e => console.error('错误:', e))
```

### 检查 2: 后端是否正常

访问: http://localhost:3001/health

**应该看到**:
```json
{
  "status": "ok",
  "service": "AI Web Planner Backend",
  "timestamp": "2025-10-29T14:10:00.000Z"
}
```

### 检查 3: 前端是否能访问后端

在浏览器控制台执行:
```javascript
fetch('/api/llm-proxy', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ test: true })
})
.then(r => r.text())
.then(t => console.log('响应:', t))
```

---

## 💡 常见错误和解决方案

### 错误 1: "Network Error"

**原因**: 前端无法访问后端代理

**解决**:
1. 检查 nginx 配置
2. 检查后端容器是否运行: `docker-compose ps`
3. 重启容器: `docker-compose restart`

### 错误 2: "404 Not Found"

**原因**: Endpoint 配置错误

**解决**:
1. 确认使用正确的 endpoint
2. 清除 localStorage
3. 重新配置

### 错误 3: "401 Unauthorized"

**原因**: API Key 无效

**解决**:
1. 检查 API Key 是否正确
2. 检查 API Key 是否过期
3. 在阿里云控制台重新生成 Key

### 错误 4: "429 Too Many Requests"

**原因**: API 调用频率过高

**解决**:
1. 等待 1-2 分钟
2. 减少测试频率
3. 检查是否有其他程序在调用

---

## 📋 完整的配置检查清单

- [ ] 浏览器缓存已清除
- [ ] localStorage 已清除
- [ ] 前端容器已重新构建
- [ ] 后端容器正常运行
- [ ] API Key 正确
- [ ] API Endpoint 正确
- [ ] 网络连接正常
- [ ] 后端日志显示成功
- [ ] 测试通过

---

## 🎯 推荐操作流程

```
1. 打开无痕窗口 (Ctrl + Shift + N)
   ↓
2. 访问 http://localhost:3000
   ↓
3. 注册新账号 (或登录)
   ↓
4. 点击设置 ⚙️
   ↓
5. 填写正确的 API Key 和 Endpoint
   ↓
6. 保存配置
   ↓
7. 测试 AI 对话
   ↓
8. 看到 ✅ 测试成功
```

---

**创建时间**: 2025-10-29  
**状态**: ✅ 完整解决方案

