import axios from 'axios';
import { useApiConfigStore } from '../store/apiConfigStore';
import type { TravelPlan, DayItinerary } from '../types/common';

/**
 * AI å¤§è¯­è¨€æ¨¡å‹æœåŠ¡
 * ä½¿ç”¨é˜¿é‡Œäº‘é€šä¹‰åƒé—®ï¼ˆç™¾ç‚¼å¹³å°ï¼‰
 */

/**
 * è·å– LLM API é…ç½®
 */
const getLLMConfig = () => {
  const { config } = useApiConfigStore.getState();
  const apiKey = config.llm_api_key || import.meta.env.VITE_ALIYUN_LLM_API_KEY;
  const endpoint = config.llm_endpoint || import.meta.env.VITE_ALIYUN_LLM_ENDPOINT;

  if (!apiKey || !endpoint) {
    throw new Error('LLM API æœªé…ç½®ï¼Œè¯·åœ¨è®¾ç½®é¡µé¢é…ç½®');
  }

  return { apiKey, endpoint };
};

/**
 * è°ƒç”¨ LLM API (æ”¯æŒå¤šç§AIæœåŠ¡)
 */
const callLLM = async (prompt: string, systemPrompt?: string): Promise<string> => {
  const { apiKey, endpoint } = getLLMConfig();

  // æ£€æµ‹AIæœåŠ¡ç±»å‹
  const isOpenAI = endpoint.includes('openai.com');
  const isBaidu = endpoint.includes('baidu');
  const isAliyun = endpoint.includes('aliyun') || endpoint.includes('bailian');

  try {
    // æ„å»ºæ¶ˆæ¯æ•°ç»„
    const messages = [
      ...(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []),
      { role: 'user', content: prompt },
    ];

    // æ ¹æ®ä¸åŒæœåŠ¡æ„å»ºè¯·æ±‚ä½“
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let requestBody: any;
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const headers: any = {
      'Content-Type': 'application/json',
    };
    let apiEndpoint = endpoint;

    if (isOpenAI) {
      // OpenAI æ ¼å¼ - ç›´æ¥è°ƒç”¨
      requestBody = {
        model: 'gpt-3.5-turbo',
        messages: messages,
        temperature: 0.7,
        max_tokens: 4000, // å¢åŠ æœ€å¤§tokenæ•°ä»¥æ”¯æŒæ›´é•¿çš„å›å¤
      };
      headers.Authorization = `Bearer ${apiKey}`;
    } else if (isBaidu) {
      // ç™¾åº¦æ–‡å¿ƒä¸€è¨€æ ¼å¼ - ç›´æ¥è°ƒç”¨
      requestBody = {
        messages: messages,
        temperature: 0.7,
        max_output_tokens: 4000, // å¢åŠ æœ€å¤§tokenæ•°
      };
      headers.Authorization = `Bearer ${apiKey}`;
    } else if (isAliyun) {
      // é˜¿é‡Œäº‘ç™¾ç‚¼ - ä½¿ç”¨ä»£ç†
      console.log('ä½¿ç”¨ä»£ç†è°ƒç”¨é˜¿é‡Œäº‘ç™¾ç‚¼API');

      // ä½¿ç”¨åç«¯ä»£ç†
      // é€šè¿‡nginxåå‘ä»£ç†åˆ°åç«¯æœåŠ¡
      // /api/llm-proxy -> http://backend:3001/api/llm-proxy
      const proxyUrl = '/api/llm-proxy';

      requestBody = {
        prompt,
        systemPrompt,
        apiKey,
        endpoint,
      };
      apiEndpoint = proxyUrl;
      // ä¸éœ€è¦Authorization headerï¼Œåœ¨ä»£ç†ä¸­å¤„ç†
      delete headers.Authorization;
    } else {
      // å…¶ä»–æœåŠ¡ - é»˜è®¤æ ¼å¼
      requestBody = {
        model: 'qwen-plus',
        input: {
          messages: messages,
        },
        parameters: {
          result_format: 'message',
          temperature: 0.7,
          top_p: 0.8,
          max_tokens: 4000, // å¢åŠ æœ€å¤§tokenæ•°
        },
      };
      headers.Authorization = `Bearer ${apiKey}`;
    }

    console.log('è°ƒç”¨AIæœåŠ¡:', {
      endpoint: apiEndpoint,
      isOpenAI,
      isBaidu,
      isAliyun,
      useProxy: isAliyun
    });

    const response = await axios.post(apiEndpoint, requestBody, {
      headers,
      timeout: 300000, // 300ç§’è¶…æ—¶ (5åˆ†é’Ÿ)
      // æ·»åŠ é‡è¯•é…ç½®
      validateStatus: (status) => status < 500, // åªæœ‰5xxé”™è¯¯æ‰æŠ›å‡ºå¼‚å¸¸
    });

    // æ ¹æ®ä¸åŒæœåŠ¡è§£æå“åº”
    let content: string | null = null;

    if (isOpenAI) {
      // OpenAI å“åº”æ ¼å¼
      content = response.data?.choices?.[0]?.message?.content;
    } else if (isBaidu) {
      // ç™¾åº¦å“åº”æ ¼å¼
      content = response.data?.result;
    } else {
      // é˜¿é‡Œäº‘ç™¾ç‚¼å“åº”æ ¼å¼
      content = response.data?.output?.choices?.[0]?.message?.content;
    }

    if (content) {
      console.log('âœ… AIå“åº”æˆåŠŸï¼Œå†…å®¹é•¿åº¦:', content.length);
      console.log('ğŸ“ AIå“åº”å†…å®¹é¢„è§ˆ:', content.substring(0, 200) + '...');
      return content;
    }

    console.error('âŒ AIå“åº”æ ¼å¼é”™è¯¯:', {
      hasData: !!response.data,
      hasOutput: !!response.data?.output,
      hasChoices: !!response.data?.output?.choices,
      responseKeys: Object.keys(response.data || {}),
      fullResponse: JSON.stringify(response.data).substring(0, 500)
    });
    throw new Error('AI å“åº”æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
  } catch (error: any) {
    console.error('LLM API è°ƒç”¨å¤±è´¥:', error);

    // è¯¦ç»†çš„é”™è¯¯å¤„ç†
    if (error.code === 'ECONNABORTED' || error.message?.includes('timeout')) {
      throw new Error('AIæœåŠ¡å“åº”è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•ã€‚å¦‚æœé—®é¢˜æŒç»­ï¼Œè¯·å°è¯•å‡å°‘è¯·æ±‚å†…å®¹æˆ–è”ç³»ç®¡ç†å‘˜');
    }
    if (error.response?.status === 401) {
      throw new Error('API Key æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®');
    }
    if (error.response?.status === 429) {
      throw new Error('API è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•');
    }
    if (error.response?.status === 403) {
      throw new Error('API é…é¢å·²ç”¨å®Œï¼Œè¯·å……å€¼æˆ–æ›´æ¢ Key');
    }
    if (error.response?.status === 504) {
      throw new Error('AIæœåŠ¡å“åº”è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
    }
    if (error.message === 'Network Error') {
      throw new Error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä»£ç†æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸');
    }
    if (error.response?.data?.error) {
      throw new Error(`AIæœåŠ¡é”™è¯¯: ${error.response.data.error}`);
    }

    throw new Error(`AI æœåŠ¡è°ƒç”¨å¤±è´¥: ${error.message}`);
  }
};

/**
 * æå–ç”¨æˆ·è¾“å…¥ä¸­çš„å…·ä½“æ™¯ç‚¹
 */
const extractSpecificAttractions = (text: string): string[] => {
  const attractions: string[] = [];

  // å¸¸è§æ™¯ç‚¹å…³é”®è¯æ¨¡å¼
  const patterns = [
    /(?:å»|åˆ°|çœ‹|å‚è§‚|æ¸¸è§ˆ|è®¿é—®)([^ï¼Œã€‚ã€,.\s]{2,10}(?:å¯º|å¡”|å±±|æ¹–|å®«|æ®¿|åŸ|æ¥¼|é¦†|å›­|å²›|æ¡¥|å¹¿åœº|å…¬å›­|æ™¯åŒº|é—å€|æ•…å±…))/g,
    /([^ï¼Œã€‚ã€,.\s]{2,10}(?:å¯º|å¡”|å±±|æ¹–|å®«|æ®¿|åŸ|æ¥¼|é¦†|å›­|å²›|æ¡¥|å¹¿åœº|å…¬å›­|æ™¯åŒº|é—å€|æ•…å±…))/g,
  ];

  patterns.forEach(pattern => {
    const matches = text.matchAll(pattern);
    for (const match of matches) {
      const attraction = match[1] || match[0];
      if (attraction && !attractions.includes(attraction)) {
        attractions.push(attraction);
      }
    }
  });

  // ç‰¹æ®Šæ™¯ç‚¹åç§°ï¼ˆä¸å«åç¼€ï¼‰
  const specialAttractions = [
    'æµ…è‰å¯º', 'ä¸œäº¬å¡”', 'æ™´ç©ºå¡”', 'å¯Œå£«å±±', 'æ¸…æ°´å¯º', 'é‡‘é˜å¯º', 'é“¶é˜å¯º',
    'åŸƒè²å°”é“å¡”', 'å¢æµ®å®«', 'å‡¯æ—‹é—¨', 'è‡ªç”±å¥³ç¥åƒ', 'æ—¶ä»£å¹¿åœº',
    'å¤§æœ¬é’Ÿ', 'ä¼¦æ•¦çœ¼', 'ç™½é‡‘æ±‰å®«', 'å¤©å®‰é—¨', 'æ•…å®«', 'é•¿åŸ',
  ];

  specialAttractions.forEach(name => {
    if (text.includes(name) && !attractions.includes(name)) {
      attractions.push(name);
    }
  });

  console.log('ğŸ¯ æå–åˆ°çš„å…·ä½“æ™¯ç‚¹:', attractions);
  return attractions;
};

/**
 * ç”Ÿæˆæ—…è¡Œè®¡åˆ’
 */
export const generateTravelPlan = async (params: {
  destination: string;
  days: number;
  budget: number;
  travelers: number;
  preferences: string[];
  startDate?: string;
  departureCity?: string; // æ–°å¢ï¼šå‡ºå‘åŸå¸‚
  userInput?: string; // æ–°å¢ï¼šç”¨æˆ·åŸå§‹è¾“å…¥
}): Promise<{ destination: string; itinerary: DayItinerary[]; suggestions: string; budget?: number; travelers?: number; preferences?: string[] }> => {
  // æå–ç”¨æˆ·æŒ‡å®šçš„å…·ä½“æ™¯ç‚¹
  const specificAttractions = params.userInput ? extractSpecificAttractions(params.userInput) : [];

  const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—…è¡Œè§„åˆ’åŠ©æ‰‹ï¼Œæ‹¥æœ‰ä¸°å¯Œçš„æ—…æ¸¸ç»éªŒå’Œåœ°ç†çŸ¥è¯†ã€‚è¯·æ ¹æ®ç”¨æˆ·éœ€æ±‚ç”Ÿæˆè¯¦ç»†ã€å®ç”¨ã€å¯æ‰§è¡Œçš„æ—…è¡Œè®¡åˆ’ã€‚

ğŸ“‹ æ ¸å¿ƒè¦æ±‚ï¼š
1. å¿…é¡»ç›´æ¥è¿”å›çº¯ JSON å¯¹è±¡ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown æ ‡è®°ï¼ˆå¦‚ \`\`\`jsonï¼‰
2. ä¸è¦å¯¹ JSON è¿›è¡Œè½¬ä¹‰ï¼Œç›´æ¥è¿”å›åŸå§‹ JSON å¯¹è±¡
3. JSON ä¸­çš„å­—ç¬¦ä¸²å€¼å¯ä»¥åŒ…å«ä¸­æ–‡ï¼Œä½†ä¸è¦ä½¿ç”¨è½¬ä¹‰çš„å¼•å·
4. åŒ…å«æ¯æ—¥è¯¦ç»†è¡Œç¨‹ï¼Œç²¾ç¡®åˆ°å°æ—¶çº§åˆ«
5. åŒ…å«äº¤é€šã€ä½å®¿ã€é¤é¥®ã€æ™¯ç‚¹æ¨è
6. è€ƒè™‘æ—¶é—´å®‰æ’çš„åˆç†æ€§å’Œå¯è¡Œæ€§
7. æä¾›é¢„ç®—å»ºè®®å’Œçœé’±æŠ€å·§
8. ç¡®ä¿è¿”å›çš„å†…å®¹å¯ä»¥è¢« JSON.parse() ç›´æ¥è§£æ

ğŸ¯ è§„åˆ’åŸåˆ™ï¼š
1. **çœŸå®æ€§**ï¼šæ‰€æœ‰æ™¯ç‚¹ã€é¤å…ã€é…’åº—å¿…é¡»æ˜¯çœŸå®å­˜åœ¨çš„ï¼Œåæ ‡å¿…é¡»å‡†ç¡®
2. **å¯è¡Œæ€§**ï¼šæ—¶é—´å®‰æ’è¦åˆç†ï¼Œè€ƒè™‘æ’é˜Ÿã€ç”¨é¤ã€ä¼‘æ¯æ—¶é—´
3. **ç»æµæ€§**ï¼šåœ¨é¢„ç®—èŒƒå›´å†…æä¾›æœ€ä¼˜æ–¹æ¡ˆï¼Œæ ‡æ³¨çœé’±æŠ€å·§
4. **èˆ’é€‚æ€§**ï¼šé¿å…è¿‡åº¦ç–²åŠ³ï¼Œåˆç†å®‰æ’ä¼‘æ¯æ—¶é—´
5. **æœ¬åœ°åŒ–**ï¼šæ¨èå½“åœ°ç‰¹è‰²ç¾é£Ÿã€æ–‡åŒ–ä½“éªŒã€éšè—æ™¯ç‚¹
6. **å­£èŠ‚æ€§**ï¼šè€ƒè™‘æ—…è¡Œæ—¥æœŸçš„å­£èŠ‚ç‰¹ç‚¹å’Œå¤©æ°”æƒ…å†µ
7. **å®‰å…¨æ€§**ï¼šæé†’æ³¨æ„äº‹é¡¹ã€é¿å…å±é™©åŒºåŸŸ

âš ï¸ é‡è¦åæ ‡è¦æ±‚ï¼š
- æ¯ä¸ªæ™¯ç‚¹(attraction)ã€é¤å…(restaurant)ã€ä½å®¿(accommodation)éƒ½å¿…é¡»åŒ…å« coordinates å­—æ®µ
- coordinates æ ¼å¼å¿…é¡»æ˜¯æ•°ç»„: [ç»åº¦, çº¬åº¦]ï¼Œä¾‹å¦‚: [116.397428, 39.90923]
- ç»åº¦åœ¨å‰ï¼Œçº¬åº¦åœ¨å
- åæ ‡å¿…é¡»æ˜¯çœŸå®çš„åœ°ç†åæ ‡ï¼Œä¸èƒ½æ˜¯è™šå‡æ•°æ®
- å¦‚æœä¸ç¡®å®šåæ ‡ï¼Œè¯·ä½¿ç”¨è¯¥åŸå¸‚çš„çŸ¥ååœ°æ ‡åæ ‡

ğŸ’° é‡è¦ä»·æ ¼è¦æ±‚ï¼š
- æ‰€æœ‰ä»·æ ¼å­—æ®µï¼ˆticket_priceã€costã€price_per_nightã€price_per_personï¼‰å¿…é¡»æ˜¯æ•°å­—ç±»å‹
- å…è´¹çš„æ™¯ç‚¹/æ´»åŠ¨ï¼Œticket_price å’Œ cost å¿…é¡»è®¾ç½®ä¸º 0ï¼ˆæ•°å­—é›¶ï¼‰ï¼Œä¸è¦çœç•¥è¿™äº›å­—æ®µ
- ä¾‹å¦‚ï¼šå¤©å®‰é—¨å¹¿åœºã€å…¬å›­ç­‰å…è´¹æ™¯ç‚¹ï¼Œå¿…é¡»å†™ "ticket_price": 0, "cost": 0
- ä»˜è´¹æ™¯ç‚¹å¿…é¡»æä¾›çœŸå®çš„é—¨ç¥¨ä»·æ ¼
- ä¸è¦ä½¿ç”¨å­—ç¬¦ä¸² "å…è´¹"ï¼Œå¿…é¡»ä½¿ç”¨æ•°å­— 0
- æ ‡æ³¨å­¦ç”Ÿç¥¨ã€è€äººç¥¨ç­‰ä¼˜æƒ ä¿¡æ¯ï¼ˆåœ¨ tips å­—æ®µä¸­ï¼‰

ğŸ­ æ™¯ç‚¹è§„åˆ’è¦æ±‚ï¼ˆæ ¸å¿ƒï¼‰ï¼š
- æ¯ä¸ªæ™¯ç‚¹å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
  * id: å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚"act1"ï¼‰
  * type: "attraction"ï¼ˆå›ºå®šå€¼ï¼‰
  * name: æ™¯ç‚¹åç§°ï¼ˆå¿…å¡«ï¼ŒçœŸå®æ™¯ç‚¹ï¼‰
  * address: è¯¦ç»†åœ°å€ï¼ˆå¿…å¡«ï¼‰
  * coordinates: [ç»åº¦, çº¬åº¦]ï¼ˆå¿…å¡«ï¼ŒçœŸå®åæ ‡ï¼‰
  * start_time: å¼€å§‹æ—¶é—´ï¼ˆå¦‚"09:00"ï¼‰
  * end_time: ç»“æŸæ—¶é—´ï¼ˆå¦‚"11:30"ï¼‰
  * duration: æ¸¸è§ˆæ—¶é•¿ï¼ˆå¦‚"2å°æ—¶30åˆ†é’Ÿ"ï¼‰
  * ticket_price: é—¨ç¥¨ä»·æ ¼ï¼ˆæ•°å­—ç±»å‹ï¼Œå…è´¹ä¸º0ï¼‰
  * cost: æ€»è´¹ç”¨ï¼ˆæ•°å­—ç±»å‹ï¼ŒåŒ…å«é—¨ç¥¨å’Œå…¶ä»–è´¹ç”¨ï¼‰
  * description: æ™¯ç‚¹ä»‹ç»ï¼ˆå¿…å¡«ï¼Œ100-200å­—ï¼‰
  * highlights: æ¸¸è§ˆäº®ç‚¹ï¼ˆå¯é€‰ï¼Œæ•°ç»„æ ¼å¼ï¼‰
  * tips: æ¸¸è§ˆå»ºè®®ï¼ˆå¯é€‰ï¼Œå¦‚"å»ºè®®æ—©ä¸Šå»é¿å¼€äººæµ"ã€"éœ€è¦æå‰é¢„çº¦"ï¼‰
  * opening_hours: å¼€æ”¾æ—¶é—´ï¼ˆå¯é€‰ï¼Œå¦‚"08:00-18:00"ï¼‰
- æ™¯ç‚¹é€‰æ‹©è¦æ±‚ï¼š
  * ä¼˜å…ˆæ¨èå¿…æ¸¸æ™¯ç‚¹å’Œç½‘çº¢æ‰“å¡åœ°
  * è€ƒè™‘æ™¯ç‚¹çš„å­£èŠ‚æ€§å’Œå¤©æ°”å½±å“
  * åˆç†å®‰æ’æ¸¸è§ˆé¡ºåºï¼Œå‡å°‘å¾€è¿”è·¯ç¨‹
  * æ ‡æ³¨éœ€è¦æå‰é¢„çº¦çš„æ™¯ç‚¹
  * æé†’æ’é˜Ÿæ—¶é—´å’Œæœ€ä½³æ¸¸è§ˆæ—¶é—´
  * é¿å…åœ¨åŒä¸€å¤©å®‰æ’è¿‡å¤šæ™¯ç‚¹ï¼Œå¯¼è‡´èµ°é©¬è§‚èŠ±
- æ¸¸è§ˆæ—¶é—´å®‰æ’ï¼š
  * å¤§å‹æ™¯ç‚¹ï¼ˆæ•…å®«ã€åšç‰©é¦†ï¼‰ï¼šé¢„ç•™3-4å°æ—¶
  * ä¸­å‹æ™¯ç‚¹ï¼ˆå…¬å›­ã€å¯ºåº™ï¼‰ï¼šé¢„ç•™1.5-2å°æ—¶
  * å°å‹æ™¯ç‚¹ï¼ˆè¡—åŒºã€å•†åœˆï¼‰ï¼šé¢„ç•™1-1.5å°æ—¶
  * è€ƒè™‘æ’é˜Ÿæ—¶é—´ã€æ‹ç…§æ—¶é—´ã€ä¼‘æ¯æ—¶é—´
  * é¿å…å®‰æ’è¿‡äºç´§å‡‘ï¼Œé¢„ç•™å¼¹æ€§æ—¶é—´

ğŸš— é‡è¦äº¤é€šè§„åˆ’è¦æ±‚ï¼ˆæ–°å¢ï¼‰ï¼š
- æ¯ä¸¤ä¸ªç›¸é‚»æ´»åŠ¨ï¼ˆæ™¯ç‚¹ã€é¤å…ã€è´­ç‰©ç­‰ï¼‰ä¹‹é—´å¿…é¡»æ’å…¥ä¸€ä¸ªäº¤é€šæ´»åŠ¨ï¼ˆtype: "transport"ï¼‰
- äº¤é€šæ–¹å¼é€‰æ‹©è§„åˆ™ï¼š
  * æ­¥è¡Œè·ç¦» < 1kmï¼šä½¿ç”¨"æ­¥è¡Œ"
  * 1km â‰¤ è·ç¦» < 3kmï¼šä½¿ç”¨"åœ°é“"æˆ–"å…¬äº¤"
  * è·ç¦» â‰¥ 3kmï¼šä½¿ç”¨"åœ°é“"ã€"å…¬äº¤"æˆ–"å‡ºç§Ÿè½¦"
- äº¤é€šæ´»åŠ¨å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
  * id: å”¯ä¸€æ ‡è¯†ï¼ˆå¦‚"trans1"ï¼‰
  * type: "transport"ï¼ˆå›ºå®šå€¼ï¼‰
  * name: äº¤é€šæè¿°ï¼ˆå¦‚"å‰å¾€æ™¯å±±å…¬å›­"ï¼‰
  * from: å‡ºå‘åœ°ç‚¹åç§°
  * to: ç›®çš„åœ°ç‚¹åç§°
  * method: äº¤é€šæ–¹å¼ï¼ˆæ­¥è¡Œã€åœ°é“ã€å…¬äº¤ã€å‡ºç§Ÿè½¦ã€ç½‘çº¦è½¦ï¼‰
  * details: å…·ä½“è·¯çº¿ï¼ˆå¦‚"åœ°é“1å·çº¿ï¼Œå¤©å®‰é—¨ä¸œç«™â†’ç‹åºœäº•ç«™ï¼Œ2ç«™"æˆ–"ä»æ•…å®«åŒ—é—¨å‡ºï¼Œæ­¥è¡Œçº¦5åˆ†é’Ÿ"ï¼‰
  * start_time: å‡ºå‘æ—¶é—´ï¼ˆä¸ä¸Šä¸€ä¸ªæ´»åŠ¨çš„end_timeä¸€è‡´ï¼‰
  * end_time: åˆ°è¾¾æ—¶é—´
  * duration: é¢„è®¡æ—¶é—´ï¼ˆå¦‚"15åˆ†é’Ÿ"ï¼‰
  * cost: é¢„è®¡è´¹ç”¨ï¼ˆæ•°å­—ç±»å‹ï¼Œæ­¥è¡Œä¸º0ï¼Œåœ°é“2-5å…ƒï¼Œå…¬äº¤1-2å…ƒï¼Œå‡ºç§Ÿè½¦èµ·æ­¥ä»·13å…ƒï¼‰
  * description: äº¤é€šè¯´æ˜ï¼ˆå¦‚"æ­¥è¡Œå‰å¾€æ™¯å±±å…¬å›­"æˆ–"ä¹˜ååœ°é“8å·çº¿å‰å¾€ç‹åºœäº•"ï¼‰
- äº¤é€šæ—¶é—´è¦åˆç†ï¼Œè€ƒè™‘ç­‰è½¦ã€æ¢ä¹˜æ—¶é—´ï¼š
  * æ­¥è¡Œï¼šæŒ‰5km/hè®¡ç®—
  * åœ°é“ï¼šåŒ…å«ç­‰è½¦5åˆ†é’Ÿ + ä¹˜è½¦æ—¶é—´ + æ¢ä¹˜æ—¶é—´
  * å…¬äº¤ï¼šåŒ…å«ç­‰è½¦10åˆ†é’Ÿ + ä¹˜è½¦æ—¶é—´
  * å‡ºç§Ÿè½¦ï¼šæŒ‰å®é™…è·¯å†µä¼°ç®—
- äº¤é€šè´¹ç”¨è¦çœŸå®ï¼š
  * æ­¥è¡Œï¼š0å…ƒ
  * åœ°é“ï¼š2-5å…ƒï¼ˆæ ¹æ®è·ç¦»ï¼‰
  * å…¬äº¤ï¼š1-2å…ƒ
  * å‡ºç§Ÿè½¦ï¼šèµ·æ­¥ä»·13å…ƒ + é‡Œç¨‹è´¹
  * ç½‘çº¦è½¦ï¼šæ¯”å‡ºç§Ÿè½¦ç•¥è´µ10-20%

ğŸ´ é¤é¥®å®‰æ’è¦æ±‚ï¼ˆé‡è¦ï¼‰ï¼š
- æ¯å¤©å¿…é¡»åŒ…å« meals æ•°ç»„ï¼Œè‡³å°‘åŒ…å«åˆé¤(lunch)å’Œæ™šé¤(dinner)
- æ—©é¤(breakfast)å¯é€‰ï¼Œå¦‚æœé…’åº—åŒ…å«æ—©é¤åˆ™ä¸éœ€è¦å•ç‹¬åˆ—å‡º
- æ¯ä¸ªé¤é¥®é¡¹å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
  * type: "breakfast"ï¼ˆæ—©é¤ï¼‰ã€"lunch"ï¼ˆåˆé¤ï¼‰ã€"dinner"ï¼ˆæ™šé¤ï¼‰æˆ–"snack"ï¼ˆå°åƒï¼‰
  * name: é¤å…åç§°ï¼ˆå¿…å¡«ï¼Œä¸èƒ½ä¸ºç©ºï¼‰
  * restaurant: é¤å…å…¨ç§°ï¼ˆå¯ä¸nameç›¸åŒï¼‰
  * address: è¯¦ç»†åœ°å€ï¼ˆå¿…å¡«ï¼‰
  * location: åæ ‡å¯¹è±¡ { lat: çº¬åº¦, lng: ç»åº¦ }ï¼ˆå¿…å¡«ï¼‰
  * cuisine: èœç³»ç±»å‹ï¼ˆå¦‚"å·èœ"ã€"æ—¥æ–™"ã€"è¥¿é¤"ã€"ç«é”…"ç­‰ï¼‰
  * price_per_person: äººå‡æ¶ˆè´¹ï¼ˆæ•°å­—ç±»å‹ï¼Œå¿…å¡«ï¼‰
  * rating: è¯„åˆ†ï¼ˆå¯é€‰ï¼Œ1-5åˆ†ï¼‰
  * specialties: æ¨èèœå“ï¼ˆå¯é€‰ï¼Œæ•°ç»„æ ¼å¼ï¼Œå¦‚["å®«ä¿é¸¡ä¸", "éº»å©†è±†è…"]ï¼‰
  * tips: ç”¨é¤å»ºè®®ï¼ˆå¯é€‰ï¼Œå¦‚"å»ºè®®æå‰é¢„çº¦"ã€"é¿å¼€ç”¨é¤é«˜å³°æœŸ"ï¼‰
- é¤å…é€‰æ‹©è¦æ±‚ï¼š
  * ä¼˜å…ˆæ¨èå½“åœ°ç‰¹è‰²ç¾é£Ÿå’Œè€å­—å·é¤å…
  * è€ƒè™‘é¤å…ä½ç½®ï¼Œå°½é‡åœ¨æ™¯ç‚¹é™„è¿‘ï¼Œå‡å°‘å¾€è¿”æ—¶é—´
  * ä»·æ ¼è¦ç¬¦åˆç”¨æˆ·é¢„ç®—ï¼Œæä¾›ä¸åŒæ¡£æ¬¡çš„é€‰æ‹©
  * æ ‡æ³¨äººæ°”é¤å…ï¼Œæé†’éœ€è¦æå‰é¢„çº¦æˆ–æ’é˜Ÿ
  * æ¨èå…·ä½“èœå“ï¼Œè®©ç”¨æˆ·çŸ¥é“åƒä»€ä¹ˆ
  * è€ƒè™‘ç”¨æˆ·çš„é¥®é£Ÿåå¥½å’Œç¦å¿Œ
  * ä½ç½®è¦åœ¨å½“å¤©è¡Œç¨‹è·¯çº¿é™„è¿‘ï¼Œæ–¹ä¾¿å°±é¤
- é¤é¥®æ—¶é—´å®‰æ’ï¼š
  * æ—©é¤ï¼š07:00-09:00ï¼ˆå¦‚æœä¸åŒ…å«åœ¨é…’åº—ï¼‰
  * åˆé¤ï¼š11:30-13:30ï¼ˆé¢„ç•™1-1.5å°æ—¶ç”¨é¤æ—¶é—´ï¼‰
  * æ™šé¤ï¼š17:30-20:00ï¼ˆé¢„ç•™1.5-2å°æ—¶ç”¨é¤æ—¶é—´ï¼‰
  * å°åƒï¼šå¯ç©¿æ’åœ¨è¡Œç¨‹ä¸­ï¼ˆ10:00-11:00æˆ–15:00-16:00ï¼‰

ğŸ¨ ä½å®¿å®‰æ’è¦æ±‚ï¼š
- æ¯å¤©å¿…é¡»åŒ…å« accommodation å¯¹è±¡ï¼ˆæœ€åä¸€å¤©è¿”ç¨‹é™¤å¤–ï¼‰
- ä½å®¿ä¿¡æ¯å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
  * name: é…’åº—åç§°ï¼ˆå¿…å¡«ï¼ŒçœŸå®é…’åº—ï¼‰
  * address: è¯¦ç»†åœ°å€ï¼ˆå¿…å¡«ï¼‰
  * location: åæ ‡å¯¹è±¡ { lat: çº¬åº¦, lng: ç»åº¦ }ï¼ˆå¿…å¡«ï¼‰
  * price_per_night: æ¯æ™šä»·æ ¼ï¼ˆæ•°å­—ç±»å‹ï¼Œå¿…å¡«ï¼‰
  * rating: è¯„åˆ†ï¼ˆå¯é€‰ï¼Œ1-5åˆ†ï¼‰
  * facilities: è®¾æ–½åˆ—è¡¨ï¼ˆå¯é€‰ï¼Œå¦‚["WiFi", "æ—©é¤", "åœè½¦åœº"]ï¼‰
  * tips: å…¥ä½å»ºè®®ï¼ˆå¯é€‰ï¼Œå¦‚"è¿‘åœ°é“ç«™"ã€"å«æ—©é¤"ï¼‰
- é…’åº—é€‰æ‹©è¦æ±‚ï¼š
  * ä½ç½®ä¾¿åˆ©ï¼Œé è¿‘åœ°é“ç«™æˆ–ä¸»è¦æ™¯ç‚¹
  * ä»·æ ¼ç¬¦åˆé¢„ç®—ï¼Œæ€§ä»·æ¯”é«˜
  * ä¼˜å…ˆæ¨èè¿é”é…’åº—æˆ–å£ç¢‘å¥½çš„é…’åº—
  * æ ‡æ³¨é…’åº—ç‰¹è‰²å’Œä¼˜åŠ¿
  * è€ƒè™‘å®‰å…¨æ€§å’Œå«ç”Ÿæ¡ä»¶

âœˆï¸ åŸé™…äº¤é€šè¦æ±‚ï¼ˆé‡è¦ï¼å¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
${params.departureCity ? `
âš ï¸ ç”¨æˆ·å‡ºå‘åŸå¸‚ï¼š${params.departureCity}
âš ï¸ æ—…è¡Œç›®çš„åœ°ï¼š${params.destination}

ğŸ”´ å¾€è¿”äº¤é€šè§„åˆ’ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
- ç¬¬ä¸€å¤©ï¼šå¿…é¡»å®‰æ’ä»"${params.departureCity}"åˆ°"${params.destination}"çš„äº¤é€š
- æœ€åä¸€å¤©ï¼ˆç¬¬${params.days}å¤©ï¼‰ï¼šå¿…é¡»å®‰æ’ä»"${params.destination}"è¿”å›"${params.departureCity}"çš„äº¤é€š
- âŒ ç¦æ­¢å‡ºç°ç¬¬ä¸‰ä¸ªåŸå¸‚ï¼è¿”ç¨‹ç›®çš„åœ°å¿…é¡»æ˜¯å‡ºå‘åŸå¸‚"${params.departureCity}"
- âŒ ä¸è¦è§„åˆ’"${params.destination}"åˆ°å…¶ä»–åŸå¸‚çš„äº¤é€š
- âœ… æ­£ç¡®ç¤ºä¾‹ï¼š${params.departureCity} â†’ ${params.destination}ï¼ˆå»ç¨‹ï¼‰ï¼Œ${params.destination} â†’ ${params.departureCity}ï¼ˆè¿”ç¨‹ï¼‰
- âŒ é”™è¯¯ç¤ºä¾‹ï¼š${params.departureCity} â†’ ${params.destination}ï¼ˆå»ç¨‹ï¼‰ï¼Œ${params.destination} â†’ åŒ—äº¬ï¼ˆè¿”ç¨‹ï¼‰âŒ
` : `
- å¦‚æœç”¨æˆ·æä¾›äº†å‡ºå‘åœ°ï¼Œç¬¬ä¸€å¤©å¿…é¡»åŒ…å«ä»å‡ºå‘åœ°åˆ°ç›®çš„åœ°çš„äº¤é€šä¿¡æ¯
- å¦‚æœç”¨æˆ·æä¾›äº†å‡ºå‘åœ°ï¼Œæœ€åä¸€å¤©å¿…é¡»åŒ…å«ä»ç›®çš„åœ°è¿”å›å‡ºå‘åœ°çš„äº¤é€šä¿¡æ¯
`}

ğŸš„ äº¤é€šæ–¹å¼æ™ºèƒ½é€‰æ‹©è§„åˆ™ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
æ ¹æ®ä¸¤åœ°è·ç¦»å’Œå®é™…æƒ…å†µé€‰æ‹©æœ€åˆé€‚çš„äº¤é€šæ–¹å¼ï¼š

1ï¸âƒ£ **è·ç¦» < 300kmï¼ˆçŸ­é€”ï¼‰**ï¼š
   - âœ… ä¼˜å…ˆæ¨èï¼šé«˜é“/åŠ¨è½¦ï¼ˆG/Då­—å¤´ï¼‰
   - âœ… å¤‡é€‰ï¼šå¤§å·´ã€è‡ªé©¾
   - âŒ ä¸æ¨èï¼šé£æœºï¼ˆè·ç¦»å¤ªè¿‘ï¼Œä¸åˆ’ç®—ï¼‰
   - ç¤ºä¾‹ï¼šå—äº¬â†”ä¸Šæµ·(300km)ã€åŒ—äº¬â†”å¤©æ´¥(120km)ã€å¹¿å·â†”æ·±åœ³(140km)

2ï¸âƒ£ **300km â‰¤ è·ç¦» < 1000kmï¼ˆä¸­çŸ­é€”ï¼‰**ï¼š
   - âœ… ä¼˜å…ˆæ¨èï¼šé«˜é“/åŠ¨è½¦ï¼ˆG/Då­—å¤´ï¼‰
   - âœ… å¤‡é€‰ï¼šé£æœºï¼ˆå¦‚æœé«˜é“ä¸ä¾¿æˆ–æ—¶é—´ç´§å¼ ï¼‰
   - ç¤ºä¾‹ï¼šåŒ—äº¬â†”æµå—(400km)ã€ä¸Šæµ·â†”æ­¦æ±‰(800km)ã€å¹¿å·â†”é•¿æ²™(700km)

3ï¸âƒ£ **1000km â‰¤ è·ç¦» < 2000kmï¼ˆä¸­é•¿é€”ï¼‰**ï¼š
   - âœ… ä¼˜å…ˆæ¨èï¼šé«˜é“ï¼ˆå¦‚æœæœ‰ç›´è¾¾é«˜é“ä¸”æ—¶é—´åœ¨5å°æ—¶å†…ï¼‰
   - âœ… ä¼˜å…ˆæ¨èï¼šé£æœºï¼ˆå¦‚æœé«˜é“ä¸ä¾¿æˆ–è€—æ—¶è¿‡é•¿ï¼‰
   - æ ¹æ®å…·ä½“æƒ…å†µæƒè¡¡ï¼šé«˜é“èˆ’é€‚ä½†è€—æ—¶é•¿ï¼Œé£æœºå¿«ä½†éœ€è¦å¾€è¿”æœºåœº
   - ç¤ºä¾‹ï¼šåŒ—äº¬â†”ä¸Šæµ·(1300kmï¼Œé«˜é“4.5-5.5å°æ—¶)ã€ä¸Šæµ·â†”è¥¿å®‰(1500km)

4ï¸âƒ£ **è·ç¦» â‰¥ 2000kmï¼ˆé•¿é€”ï¼‰**ï¼š
   - âœ… ä¼˜å…ˆæ¨èï¼šé£æœº
   - âœ… å¤‡é€‰ï¼šé«˜é“ï¼ˆå¦‚æœç”¨æˆ·åå¥½ç«è½¦æˆ–é¢„ç®—æœ‰é™ï¼‰
   - ç¤ºä¾‹ï¼šåŒ—äº¬â†”å¹¿å·(2100km)ã€ä¸Šæµ·â†”æ˜†æ˜(2100km)ã€åŒ—äº¬â†”ä¹Œé²æœ¨é½(3000km)

5ï¸âƒ£ **ç‰¹æ®Šæƒ…å†µè€ƒè™‘**ï¼š
   - å¦‚æœä¸¤åœ°æœ‰é«˜é“ç›´è¾¾ä¸”æ—¶é—´åœ¨4å°æ—¶å†… â†’ ä¼˜å…ˆæ¨èé«˜é“
   - å¦‚æœç”¨æˆ·é¢„ç®—æœ‰é™ â†’ ä¼˜å…ˆæ¨èé«˜é“/åŠ¨è½¦
   - å¦‚æœç”¨æˆ·æ—¶é—´ç´§å¼  â†’ ä¼˜å…ˆæ¨èé£æœº
   - å¦‚æœæ˜¯è·¨æµ·ï¼ˆå¦‚å»æµ·å—ã€å°æ¹¾ï¼‰ â†’ å¿…é¡»é€‰æ‹©é£æœº

ğŸ¯ å¸¸è§åŸå¸‚å¯¹äº¤é€šæ–¹å¼æ¨èï¼ˆå¿…é¡»å‚è€ƒï¼‰ï¼š
**çŸ­é€”ï¼ˆ< 300kmï¼‰- å¿…é¡»é€‰é«˜é“ï¼š**
- å—äº¬ â†” ä¸Šæµ·(300km)ï¼šé«˜é“Gå­—å¤´ï¼Œ1-1.5å°æ—¶ï¼Œ150-200å…ƒ âœ…
- å—äº¬ â†” æ­å·(270km)ï¼šé«˜é“Gå­—å¤´ï¼Œ1å°æ—¶ï¼Œ100-150å…ƒ âœ…
- åŒ—äº¬ â†” å¤©æ´¥(120km)ï¼šé«˜é“Cå­—å¤´ï¼Œ30åˆ†é’Ÿï¼Œ55å…ƒ âœ…
- å¹¿å· â†” æ·±åœ³(140km)ï¼šé«˜é“G/Då­—å¤´ï¼Œ30-60åˆ†é’Ÿï¼Œ75-100å…ƒ âœ…
- ä¸Šæµ· â†” è‹å·(100km)ï¼šé«˜é“Gå­—å¤´ï¼Œ25åˆ†é’Ÿï¼Œ40-50å…ƒ âœ…

**ä¸­çŸ­é€”ï¼ˆ300-1000kmï¼‰- ä¼˜å…ˆé€‰é«˜é“ï¼š**
- åŒ—äº¬ â†” æµå—(400km)ï¼šé«˜é“Gå­—å¤´ï¼Œ1.5-2å°æ—¶ï¼Œ180-250å…ƒ âœ…
- ä¸Šæµ· â†” å—äº¬(300km)ï¼šé«˜é“Gå­—å¤´ï¼Œ1-1.5å°æ—¶ï¼Œ150-200å…ƒ âœ…
- å¹¿å· â†” é•¿æ²™(700km)ï¼šé«˜é“Gå­—å¤´ï¼Œ2-2.5å°æ—¶ï¼Œ300-400å…ƒ âœ…
- ä¸Šæµ· â†” æ­¦æ±‰(800km)ï¼šé«˜é“Gå­—å¤´ï¼Œ3-4å°æ—¶ï¼Œ400-550å…ƒ âœ…

**ä¸­é•¿é€”ï¼ˆ1000-2000kmï¼‰- é«˜é“æˆ–é£æœºï¼š**
- åŒ—äº¬ â†” ä¸Šæµ·(1300km)ï¼šé«˜é“Gå­—å¤´ï¼Œ4.5-5.5å°æ—¶ï¼Œ550-950å…ƒ âœ…ï¼ˆæ¨èé«˜é“ï¼‰
- ä¸Šæµ· â†” è¥¿å®‰(1500km)ï¼šé«˜é“Gå­—å¤´ï¼Œ6-7å°æ—¶ï¼Œ500-700å…ƒ æˆ– é£æœº2å°æ—¶ï¼Œ600-1000å…ƒ
- åŒ—äº¬ â†” æ­¦æ±‰(1200km)ï¼šé«˜é“Gå­—å¤´ï¼Œ4-5å°æ—¶ï¼Œ500-700å…ƒ âœ…ï¼ˆæ¨èé«˜é“ï¼‰

**é•¿é€”ï¼ˆâ‰¥ 2000kmï¼‰- ä¼˜å…ˆé€‰é£æœºï¼š**
- åŒ—äº¬ â†” å¹¿å·(2100km)ï¼šé£æœº2.5-3å°æ—¶ï¼Œ800-1500å…ƒ âœ…ï¼ˆæ¨èé£æœºï¼‰
- ä¸Šæµ· â†” æˆéƒ½(1900km)ï¼šé£æœº2.5-3å°æ—¶ï¼Œ600-1200å…ƒ âœ…ï¼ˆæ¨èé£æœºï¼‰
- åŒ—äº¬ â†” æ˜†æ˜(2500km)ï¼šé£æœº3-3.5å°æ—¶ï¼Œ1000-1800å…ƒ âœ…ï¼ˆæ¨èé£æœºï¼‰
- ä¸Šæµ· â†” ä¹Œé²æœ¨é½(3500km)ï¼šé£æœº4-5å°æ—¶ï¼Œ1500-2500å…ƒ âœ…ï¼ˆå¿…é¡»é£æœºï¼‰

- åŸé™…äº¤é€šä¿¡æ¯æ”¾åœ¨ transportation æ•°ç»„ä¸­ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
  * type: "train"ï¼ˆé«˜é“/åŠ¨è½¦/ç«è½¦ï¼‰æˆ– "flight"ï¼ˆé£æœºï¼‰æˆ– "bus"ï¼ˆå¤§å·´ï¼‰
  * train_number æˆ– flight_number æˆ– bus_number: è½¦æ¬¡/èˆªç­å·ï¼ˆå‚è€ƒï¼Œå¦‚"G123"ã€"D456"ã€"CA1234"ï¼‰
  * from: å‡ºå‘è½¦ç«™/æœºåœºå…¨ç§°ï¼ˆå¦‚"å—äº¬å—ç«™"ã€"ä¸Šæµ·è™¹æ¡¥ç«™"ã€"åŒ—äº¬é¦–éƒ½æœºåœº"ï¼‰
  * to: åˆ°è¾¾è½¦ç«™/æœºåœºå…¨ç§°
  * from_coordinates: å‡ºå‘åœ°åæ ‡ [ç»åº¦, çº¬åº¦]ï¼ˆå¿…é¡»æä¾›å‡†ç¡®åæ ‡ï¼‰
  * to_coordinates: ç›®çš„åœ°åæ ‡ [ç»åº¦, çº¬åº¦]ï¼ˆå¿…é¡»æä¾›å‡†ç¡®åæ ‡ï¼‰
  * departure_time: å‡ºå‘æ—¶é—´ï¼ˆå¦‚"08:00"ï¼‰
  * arrival_time: åˆ°è¾¾æ—¶é—´ï¼ˆå¦‚"10:30"ï¼‰
  * duration: è¡Œç¨‹æ—¶é—´ï¼ˆå¦‚"2å°æ—¶30åˆ†é’Ÿ"ï¼‰
  * price: å‚è€ƒç¥¨ä»·ï¼ˆæ•°å­—ç±»å‹ï¼‰
  * notes: æ³¨æ„äº‹é¡¹ï¼ˆå¦‚"å»ºè®®æå‰30åˆ†é’Ÿåˆ°è¾¾è½¦ç«™"ã€"å»ºè®®æå‰2å°æ—¶åˆ°è¾¾æœºåœº"ï¼‰

- æœºåœº/è½¦ç«™åæ ‡å‚è€ƒï¼š
  * å¿…é¡»ä½¿ç”¨çœŸå®çš„æœºåœº/è½¦ç«™åæ ‡
  * åæ ‡æ ¼å¼: [ç»åº¦, çº¬åº¦]
  * å¸¸è§é«˜é“ç«™åæ ‡ï¼š
    - åŒ—äº¬å—ç«™: [116.378631, 39.865195]
    - ä¸Šæµ·è™¹æ¡¥ç«™: [121.320024, 31.194458]
    - å—äº¬å—ç«™: [118.796877, 31.955768]
    - æ­å·ä¸œç«™: [120.213184, 30.290882]
    - å¹¿å·å—ç«™: [113.264385, 23.004225]
    - æ·±åœ³åŒ—ç«™: [114.031204, 22.609699]
  * å¸¸è§æœºåœºåæ ‡ï¼š
    - åŒ—äº¬é¦–éƒ½æœºåœº: [116.584556, 40.080111]
    - ä¸Šæµ·æµ¦ä¸œæœºåœº: [121.805214, 31.143378]
    - ä¸Šæµ·è™¹æ¡¥æœºåœº: [121.336319, 31.197875]
    - å¹¿å·ç™½äº‘æœºåœº: [113.298786, 23.392436]
    - æ·±åœ³å®å®‰æœºåœº: [113.810833, 22.639444]
    - æˆéƒ½åŒæµæœºåœº: [103.947086, 30.578528]
    - æ­å·è§å±±æœºåœº: [120.434453, 30.229503]

- ç¥¨ä»·è¦çœŸå®åˆç†ï¼š
  * é«˜é“äºŒç­‰åº§ï¼šæ ¹æ®è·ç¦»ï¼Œ50-1000å…ƒ
  * åŠ¨è½¦äºŒç­‰åº§ï¼šæ ¹æ®è·ç¦»ï¼Œ40-800å…ƒ
  * å›½å†…èˆªç­ï¼š500-2000å…ƒï¼ˆæ ¹æ®è·ç¦»ï¼‰
  * å›½é™…èˆªç­ï¼š1000-5000å…ƒï¼ˆæ ¹æ®è·ç¦»ï¼‰
  * å¤§å·´ï¼šæ ¹æ®è·ç¦»ï¼Œ30-300å…ƒ

- æ—¶é—´å®‰æ’è¦åˆç†ï¼š
  * é«˜é“/åŠ¨è½¦ï¼šå»ºè®®æ—©ä¸Š7-9ç‚¹å‡ºå‘ï¼Œä¸‹åˆ4-6ç‚¹è¿”å›ï¼Œé¿å…å¤ªæ—©æˆ–å¤ªæ™š
  * é£æœºï¼šå»ºè®®æ—©ä¸Š8ç‚¹å·¦å³å‡ºå‘ï¼Œä¸‹åˆ5ç‚¹å·¦å³è¿”å›
  * å¤§å·´ï¼šæ ¹æ®è·ç¦»å®‰æ’ï¼Œé¿å…å¤œé—´å¤§å·´

â° æ—¶é—´è§„åˆ’è¦æ±‚ï¼ˆé‡è¦ï¼‰ï¼š
- æ¯æ—¥è¡Œç¨‹æ—¶é—´å®‰æ’ï¼š
  * èµ·åºŠæ—¶é—´ï¼š07:00-08:00
  * å‡ºå‘æ—¶é—´ï¼š08:30-09:00ï¼ˆé¿å…å¤ªæ—©ï¼‰
  * åˆé¤æ—¶é—´ï¼š11:30-13:30ï¼ˆé¢„ç•™1-1.5å°æ—¶ï¼‰
  * ä¸‹åˆèŒ¶æ—¶é—´ï¼š15:00-16:00ï¼ˆå¯é€‰ï¼Œç©¿æ’å°åƒï¼‰
  * æ™šé¤æ—¶é—´ï¼š17:30-20:00ï¼ˆé¢„ç•™1.5-2å°æ—¶ï¼‰
  * è¿”å›é…’åº—ï¼š20:00-21:00ï¼ˆé¿å…å¤ªæ™šï¼‰
- æ´»åŠ¨é—´éš”æ—¶é—´ï¼š
  * æ¯ä¸ªæ´»åŠ¨ä¹‹é—´é¢„ç•™15-30åˆ†é’Ÿäº¤é€šæ—¶é—´
  * ä¸Šåˆå’Œä¸‹åˆå„å®‰æ’2-3ä¸ªæ´»åŠ¨ï¼Œé¿å…è¿‡åº¦ç–²åŠ³
  * ä¸­åˆé¢„ç•™1.5-2å°æ—¶åˆé¤å’Œä¼‘æ¯æ—¶é—´
  * æ™šä¸Šé¢„ç•™è‡ªç”±æ´»åŠ¨æ—¶é—´
- ç‰¹æ®Šæ—¶é—´è€ƒè™‘ï¼š
  * ç¬¬ä¸€å¤©ï¼šè€ƒè™‘åˆ°è¾¾æ—¶é—´ï¼Œä¸‹åˆå¼€å§‹è¡Œç¨‹
  * æœ€åä¸€å¤©ï¼šä¸Šåˆå®‰æ’è½»æ¾æ´»åŠ¨ï¼Œä¸‹åˆè¿”ç¨‹
  * é¿å…åœ¨èŠ‚å‡æ—¥å®‰æ’çƒ­é—¨æ™¯ç‚¹ï¼ˆäººæµé‡å¤§ï¼‰
  * è€ƒè™‘æ™¯ç‚¹å¼€æ”¾æ—¶é—´å’Œé—­é¦†æ—¶é—´

ğŸ’¡ æ—…è¡Œå»ºè®®è¦æ±‚ï¼ˆsuggestions å­—æ®µï¼‰ï¼š
- å¿…é¡»æä¾›è¯¦ç»†çš„æ—…è¡Œå»ºè®®ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
  * æœ€ä½³æ—…è¡Œæ—¶é—´å’Œå­£èŠ‚ç‰¹ç‚¹
  * å½“åœ°å¤©æ°”æƒ…å†µå’Œç©¿è¡£å»ºè®®
  * å¿…å¤‡ç‰©å“æ¸…å•ï¼ˆè¯ä»¶ã€è¯å“ã€å……ç”µå™¨ç­‰ï¼‰
  * çœé’±æŠ€å·§ï¼ˆå¦‚è´­ä¹°å¥—ç¥¨ã€ä½¿ç”¨äº¤é€šå¡ç­‰ï¼‰
  * å®‰å…¨æ³¨æ„äº‹é¡¹ï¼ˆé˜²ç›—ã€é˜²éª—ã€ç´§æ€¥è”ç³»æ–¹å¼ï¼‰
  * å½“åœ°æ–‡åŒ–ä¹ ä¿—å’Œç¤¼ä»ª
  * ç‰¹è‰²ä½“éªŒæ¨èï¼ˆå¦‚å¤œå¸‚ã€è¡¨æ¼”ã€èŠ‚æ—¥æ´»åŠ¨ï¼‰
  * ç¾é£Ÿæ¨èå’Œå¿…åƒæ¸…å•
  * è´­ç‰©å»ºè®®å’Œç‰¹äº§æ¨è
  * åº”æ€¥é¢„æ¡ˆï¼ˆå¦‚å¤©æ°”å˜åŒ–ã€æ™¯ç‚¹å…³é—­ç­‰ï¼‰

ğŸ’° é¢„ç®—è§„åˆ’è¦æ±‚ï¼š
- é¢„ç®—åˆ†é…å»ºè®®ï¼š
  * äº¤é€šè´¹ç”¨ï¼šå æ€»é¢„ç®—çš„20-30%
  * ä½å®¿è´¹ç”¨ï¼šå æ€»é¢„ç®—çš„25-35%
  * é¤é¥®è´¹ç”¨ï¼šå æ€»é¢„ç®—çš„20-25%
  * æ™¯ç‚¹é—¨ç¥¨ï¼šå æ€»é¢„ç®—çš„15-20%
  * è´­ç‰©å¨±ä¹ï¼šå æ€»é¢„ç®—çš„10-15%
  * é¢„ç•™åº”æ€¥èµ„é‡‘ï¼šå æ€»é¢„ç®—çš„5-10%
- çœé’±æŠ€å·§ï¼š
  * æå‰é¢„è®¢äº¤é€šå’Œä½å®¿å¯äº«å—ä¼˜æƒ 
  * è´­ä¹°æ™¯ç‚¹è”ç¥¨æˆ–åŸå¸‚é€šç¥¨æ›´åˆ’ç®—
  * é€‰æ‹©å½“åœ°ç‰¹è‰²å°åƒä»£æ›¿é«˜æ¡£é¤å…
  * ä½¿ç”¨å…¬å…±äº¤é€šä»£æ›¿å‡ºç§Ÿè½¦
  * é¿å¼€æ—…æ¸¸æ—ºå­£ï¼Œä»·æ ¼æ›´å®æƒ 

ğŸ¯ ç”¨æˆ·æŒ‡å®šæ™¯ç‚¹è¦æ±‚ï¼š
${specificAttractions.length > 0 ? `- ç”¨æˆ·æ˜ç¡®è¦æ±‚è®¿é—®ä»¥ä¸‹æ™¯ç‚¹ï¼š${specificAttractions.join('ã€')}
- è¯·åŠ¡å¿…å°†è¿™äº›æ™¯ç‚¹çº³å…¥è¡Œç¨‹å®‰æ’ä¸­ï¼Œä½œä¸ºæ ¸å¿ƒæ™¯ç‚¹
- è¿™äº›æ™¯ç‚¹çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œå¿…é¡»åŒ…å«åœ¨è¡Œç¨‹ä¸­
- åœ¨è¿™äº›æ™¯ç‚¹å‘¨å›´å®‰æ’å…¶ä»–ç›¸å…³æ™¯ç‚¹å’Œæ´»åŠ¨` : '- ç”¨æˆ·æœªæŒ‡å®šå…·ä½“æ™¯ç‚¹ï¼Œè¯·æ ¹æ®ç›®çš„åœ°æ¨èçƒ­é—¨æ™¯ç‚¹'}

é‡è¦ï¼šç›´æ¥è¿”å› JSON å¯¹è±¡ï¼Œä¸è¦è¿”å› JSON å­—ç¬¦ä¸²çš„å­—ç¬¦ä¸²å½¢å¼ï¼`;

  let userPrompt = `è¯·ä¸ºæˆ‘è§„åˆ’ä¸€æ¬¡ç²¾å½©çš„æ—…è¡Œï¼Œè¦æ±‚è¯¦ç»†ã€å®ç”¨ã€å¯æ‰§è¡Œï¼

ğŸ“‹ æ—…è¡ŒåŸºæœ¬ä¿¡æ¯ï¼š
- ğŸ¯ ç›®çš„åœ°ï¼š${params.destination}
- ğŸ“… å‡ºå‘æ—¥æœŸï¼š${params.startDate || 'å¾…å®š'}
- â° è¡Œç¨‹å¤©æ•°ï¼š${params.days} å¤©
- ğŸ’° æ€»é¢„ç®—ï¼š${params.budget} å…ƒï¼ˆäººå‡ ${Math.round(params.budget / params.travelers)} å…ƒï¼‰
- ğŸ‘¥ åŒè¡Œäººæ•°ï¼š${params.travelers} äºº
- ğŸ¨ æ—…è¡Œåå¥½ï¼š${params.preferences.length > 0 ? params.preferences.join('ã€') : 'ç»¼åˆæ¸¸è§ˆ'}
${params.departureCity ? `- âœˆï¸ å‡ºå‘åŸå¸‚ï¼š${params.departureCity}` : ''}

${params.departureCity ? `
ğŸ”´ å¾€è¿”äº¤é€šè§„åˆ’ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š
- ğŸ“ å»ç¨‹ï¼šä» ${params.departureCity} å‰å¾€ ${params.destination}ï¼ˆç¬¬1å¤©ï¼‰
- ğŸ“ è¿”ç¨‹ï¼šä» ${params.destination} è¿”å› ${params.departureCity}ï¼ˆç¬¬${params.days}å¤©ï¼‰
- âš ï¸ æ ¹æ®è·ç¦»æ™ºèƒ½é€‰æ‹©äº¤é€šæ–¹å¼ï¼ˆé«˜é“/é£æœºï¼‰
- âš ï¸ è¿”ç¨‹ç›®çš„åœ°å¿…é¡»æ˜¯å‡ºå‘åŸå¸‚ ${params.departureCity}ï¼Œä¸è¦è§„åˆ’åˆ°å…¶ä»–åŸå¸‚ï¼
` : ''}

ğŸ¯ è§„åˆ’è¦æ±‚ï¼š
1. æ¯å¤©å®‰æ’2-3ä¸ªæ ¸å¿ƒæ™¯ç‚¹ï¼Œé¿å…è¿‡åº¦ç–²åŠ³
2. æ¨èå½“åœ°ç‰¹è‰²ç¾é£Ÿå’Œè€å­—å·é¤å…ï¼Œæ ‡æ³¨æ¨èèœå“
3. é€‰æ‹©æ€§ä»·æ¯”é«˜çš„ä½å®¿ï¼Œä½ç½®ä¾¿åˆ©
4. åˆç†å®‰æ’æ¸¸è§ˆé¡ºåºï¼Œå‡å°‘å¾€è¿”è·¯ç¨‹
5. æ ‡æ³¨éœ€è¦æå‰é¢„çº¦çš„æ™¯ç‚¹å’Œé¤å…
6. æä¾›çœé’±æŠ€å·§å’Œå®ç”¨å»ºè®®
7. è€ƒè™‘å­£èŠ‚ç‰¹ç‚¹å’Œå¤©æ°”æƒ…å†µ
8. é¢„ç•™å¼¹æ€§æ—¶é—´ï¼Œä¸è¦å®‰æ’è¿‡äºç´§å‡‘`;

  // å¦‚æœæœ‰å…·ä½“æ™¯ç‚¹ï¼Œæ˜ç¡®æ ‡æ³¨
  if (specificAttractions.length > 0) {
    userPrompt += `

ğŸ¯ å¿…é¡»åŒ…å«çš„æ™¯ç‚¹ï¼ˆç”¨æˆ·æ˜ç¡®è¦æ±‚ï¼‰ï¼š
${specificAttractions.map((a, i) => `${i + 1}. ${a} - è¯·æä¾›è¯¦ç»†çš„æ¸¸è§ˆå®‰æ’ã€å¼€æ”¾æ—¶é—´ã€é—¨ç¥¨ä»·æ ¼ã€çœŸå®åæ ‡`).join('\n')}

è¯·ç¡®ä¿åœ¨ç”Ÿæˆçš„è¡Œç¨‹ä¸­åŒ…å«ä»¥ä¸Šæ‰€æœ‰æ™¯ç‚¹ï¼Œå¹¶å›´ç»•è¿™äº›æ™¯ç‚¹å®‰æ’å‘¨è¾¹çš„å…¶ä»–æ´»åŠ¨ã€‚`;
  }

  userPrompt += `

è¯·è¿”å›ä»¥ä¸‹ JSON æ ¼å¼ï¼ˆæ³¨æ„ coordinates å’Œä»·æ ¼å­—æ®µæ ¼å¼ï¼‰ï¼š
{
  "destination": "ç›®çš„åœ°åŸå¸‚",
  "itinerary": [
    {
      "day": 1,
      "date": "2024-06-01",
      "theme": "ä¸»é¢˜",
      "summary": "å½“æ—¥æ¦‚è¿°",
      "activities": [
        {
          "id": "act1",
          "type": "attraction",
          "name": "æ•…å®«åšç‰©é™¢",
          "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºæ™¯å±±å‰è¡—4å·",
          "coordinates": [116.397428, 39.90923],
          "start_time": "09:00",
          "end_time": "12:00",
          "duration": "3å°æ—¶",
          "ticket_price": 60,
          "cost": 60,
          "description": "ä¸­å›½æ˜æ¸…ä¸¤ä»£çš„çš‡å®¶å®«æ®¿",
          "opening_hours": "08:30-17:00",
          "tips": "å»ºè®®æå‰ç½‘ä¸Šè´­ç¥¨"
        },
        {
          "id": "trans1",
          "type": "transport",
          "name": "å‰å¾€æ™¯å±±å…¬å›­",
          "from": "æ•…å®«åšç‰©é™¢",
          "to": "æ™¯å±±å…¬å›­",
          "method": "æ­¥è¡Œ",
          "details": "ä»æ•…å®«åŒ—é—¨å‡ºï¼Œæ­¥è¡Œçº¦5åˆ†é’Ÿ",
          "start_time": "12:00",
          "end_time": "12:05",
          "duration": "5åˆ†é’Ÿ",
          "cost": 0,
          "description": "æ­¥è¡Œå‰å¾€æ™¯å±±å…¬å›­"
        },
        {
          "id": "act2",
          "type": "attraction",
          "name": "æ™¯å±±å…¬å›­",
          "address": "åŒ—äº¬å¸‚è¥¿åŸåŒºæ™¯å±±è¥¿è¡—44å·",
          "coordinates": [116.395, 39.928],
          "start_time": "12:05",
          "end_time": "13:00",
          "duration": "55åˆ†é’Ÿ",
          "ticket_price": 2,
          "cost": 2,
          "description": "ç™»é«˜ä¿¯ç°æ•…å®«å…¨æ™¯",
          "opening_hours": "06:30-21:00",
          "tips": "ç™»ä¸‡æ˜¥äº­å¯ä¿¯ç°æ•…å®«"
        },
        {
          "id": "trans2",
          "type": "transport",
          "name": "å‰å¾€åˆé¤åœ°ç‚¹",
          "from": "æ™¯å±±å…¬å›­",
          "to": "å…¨èšå¾·çƒ¤é¸­åº—ï¼ˆç‹åºœäº•åº—ï¼‰",
          "method": "åœ°é“",
          "details": "åœ°é“8å·çº¿ï¼Œå—é”£é¼“å··ç«™â†’ç‹åºœäº•ç«™ï¼Œ2ç«™",
          "start_time": "13:00",
          "end_time": "13:15",
          "duration": "15åˆ†é’Ÿ",
          "cost": 3,
          "description": "ä¹˜ååœ°é“8å·çº¿å‰å¾€ç‹åºœäº•"
        },
        {
          "id": "meal1",
          "type": "restaurant",
          "name": "å…¨èšå¾·çƒ¤é¸­åº—ï¼ˆç‹åºœäº•åº—ï¼‰",
          "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºç‹åºœäº•å¤§è¡—198å·",
          "coordinates": [116.410, 39.915],
          "start_time": "13:15",
          "end_time": "14:30",
          "duration": "1å°æ—¶15åˆ†é’Ÿ",
          "cost": 150,
          "description": "å“å°æ­£å®—åŒ—äº¬çƒ¤é¸­",
          "cuisine": "åŒ—äº¬èœ",
          "price_per_person": 150
        }
      ],
      "accommodation": {
        "name": "é…’åº—åç§°",
        "address": "é…’åº—åœ°å€",
        "location": { "lat": 39.9, "lng": 116.4 },
        "price_per_night": 300,
        "rating": 4.5
      },
      "transportation": [
        {
          "type": "train",
          "from": "å—äº¬å—ç«™",
          "to": "ä¸Šæµ·è™¹æ¡¥ç«™",
          "from_coordinates": [118.796877, 31.955768],
          "to_coordinates": [121.320024, 31.194458],
          "departure_time": "08:00",
          "arrival_time": "09:30",
          "duration": "1å°æ—¶30åˆ†é’Ÿ",
          "price": 180,
          "train_number": "G7001ï¼ˆå‚è€ƒï¼‰",
          "notes": "å»ºè®®æå‰30åˆ†é’Ÿåˆ°è¾¾è½¦ç«™å–ç¥¨è¿›ç«™"
        }
      ],
      "notes": "ç¬¬ä¸€å¤©ä»å‡ºå‘åœ°åˆ°è¾¾ç›®çš„åœ°ï¼Œå®‰æ’è½»æ¾çš„è¡Œç¨‹"
    },
    {
      "day": ${params.days},
      "date": "æœ€åä¸€å¤©æ—¥æœŸ",
      "theme": "è¿”ç¨‹",
      "summary": "è¿”å›å‡ºå‘åœ°",
      "activities": [],
      "transportation": [
        {
          "type": "train",
          "from": "ä¸Šæµ·è™¹æ¡¥ç«™",
          "to": "å—äº¬å—ç«™",
          "from_coordinates": [121.320024, 31.194458],
          "to_coordinates": [118.796877, 31.955768],
          "departure_time": "18:00",
          "arrival_time": "19:30",
          "duration": "1å°æ—¶30åˆ†é’Ÿ",
          "price": 180,
          "train_number": "G7002ï¼ˆå‚è€ƒï¼‰",
          "notes": "è¿”ç¨‹é«˜é“ï¼Œå»ºè®®æå‰30åˆ†é’Ÿåˆ°è¾¾è½¦ç«™"
        }
      ],
      "notes": "æœ€åä¸€å¤©è¿”å›å‡ºå‘åœ°${params.departureCity ? `ï¼ˆ${params.departureCity}ï¼‰` : ''}"
    }
  ],
  "suggestions": "æ—…è¡Œå»ºè®®å’Œæ³¨æ„äº‹é¡¹"
}

${params.departureCity ? `
âš ï¸ å†æ¬¡å¼ºè°ƒè¿”ç¨‹äº¤é€šï¼š
- æœ€åä¸€å¤©ï¼ˆç¬¬${params.days}å¤©ï¼‰çš„ transportation æ•°ç»„ä¸­ï¼Œå¿…é¡»åŒ…å«ä»"${params.destination}"è¿”å›"${params.departureCity}"çš„äº¤é€š
- from å­—æ®µï¼š${params.destination}çš„æœºåœº/è½¦ç«™
- to å­—æ®µï¼š${params.departureCity}çš„æœºåœº/è½¦ç«™
- âŒ ä¸è¦å†™æˆå…¶ä»–åŸå¸‚ï¼
- âœ… æ­£ç¡®ç¤ºä¾‹ï¼š{ "from": "${params.destination}é¦–éƒ½æœºåœº", "to": "${params.departureCity}è™¹æ¡¥æœºåœº" }
` : ''}

âš ï¸ å®Œæ•´è¡Œç¨‹ç»“æ„è¯´æ˜ï¼š
1. ç¬¬ä¸€å¤©ï¼šåŒ…å«å»ç¨‹äº¤é€šï¼ˆå¦‚æœæœ‰å‡ºå‘åŸå¸‚ï¼‰+ åˆ°è¾¾åçš„æ´»åŠ¨
2. ä¸­é—´å‡ å¤©ï¼šæ­£å¸¸çš„æ—…æ¸¸æ´»åŠ¨
3. æœ€åä¸€å¤©ï¼šä¸Šåˆ/ä¸‹åˆçš„æ´»åŠ¨ + è¿”ç¨‹äº¤é€šï¼ˆå¦‚æœæœ‰å‡ºå‘åŸå¸‚ï¼‰

è¯·è¿”å›å®Œæ•´çš„ ${params.days} å¤©è¡Œç¨‹ï¼Œä¸è¦çœç•¥ä»»ä½•ä¸€å¤©ï¼

ä»¥ä¸‹æ˜¯ç®€åŒ–çš„ç¤ºä¾‹ç»“æ„ï¼ˆä»…ä¾›å‚è€ƒæ ¼å¼ï¼‰ï¼š
{
  "destination": "${params.destination}",
  "itinerary": [
    {
      "day": 1,
      "transportation": [{ "from": "${params.departureCity || 'å‡ºå‘åœ°'}", "to": "${params.destination}" }]
    },
    { "day": 2, "activities": [...] },
    ...
    {
      "day": ${params.days},
      "transportation": [{ "from": "${params.destination}", "to": "${params.departureCity || 'å‡ºå‘åœ°'}" }]
    }
  ]
}

ä»¥ä¸‹æ˜¯å®Œæ•´çš„ç¬¬ä¸€å¤©ç¤ºä¾‹ï¼ˆåŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼‰ï¼š
{
  "destination": "${params.destination}",
  "itinerary": [
    {
      "day": 1,
      "date": "${params.startDate || '2024-06-01'}",
      "theme": "æŠµè¾¾${params.destination}",
      "summary": "ä»${params.departureCity || 'å‡ºå‘åœ°'}æŠµè¾¾${params.destination}ï¼Œå¼€å§‹æ—…ç¨‹",
      "activities": [...],
      "transportation": [
        {
          "type": "train",
          "from": "${params.departureCity || 'å‡ºå‘åœ°'}ç«™",
          "to": "${params.destination}ç«™",
          "from_coordinates": [ç»åº¦, çº¬åº¦],
          "to_coordinates": [ç»åº¦, çº¬åº¦],
          "departure_time": "08:00",
          "arrival_time": "09:30",
          "duration": "1å°æ—¶30åˆ†é’Ÿ",
          "price": 180,
          "train_number": "G7001ï¼ˆå‚è€ƒè½¦æ¬¡ï¼‰",
          "notes": "å»ºè®®æå‰30åˆ†é’Ÿåˆ°è¾¾è½¦ç«™å–ç¥¨è¿›ç«™"
        }
      ],
      "meals": [
        {
          "type": "lunch",
          "name": "å…¨èšå¾·çƒ¤é¸­åº—",
          "restaurant": "å…¨èšå¾·çƒ¤é¸­åº—",
          "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºå‰é—¨å¤§è¡—30å·",
          "location": { "lat": 39.898, "lng": 116.397 },
          "cuisine": "åŒ—äº¬èœ",
          "price_per_person": 150,
          "rating": 4.5
        },
        {
          "type": "dinner",
          "name": "æµ·åº•æç«é”…",
          "restaurant": "æµ·åº•æç«é”…(ç‹åºœäº•åº—)",
          "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºç‹åºœäº•å¤§è¡—138å·",
          "location": { "lat": 39.915, "lng": 116.410 },
          "cuisine": "ç«é”…",
          "price_per_person": 120,
          "rating": 4.6
        }
      ],
      "notes": "å½“æ—¥å¤‡æ³¨"
    }
  ],
  "suggestions": "æ—…è¡Œå»ºè®®å’Œæ³¨æ„äº‹é¡¹"
}

âš ï¸ å†æ¬¡å¼ºè°ƒï¼š
1. activities æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½å¿…é¡»åŒ…å« coordinates: [ç»åº¦, çº¬åº¦]ï¼ˆtransport ç±»å‹é™¤å¤–ï¼‰
2. æ™¯ç‚¹(type: "attraction")ã€é¤å…(type: "restaurant")ã€è´­ç‰©(type: "shopping")éƒ½å¿…é¡»æœ‰ coordinates
3. äº¤é€š(type: "transport")å¿…é¡»åŒ…å« fromã€toã€methodã€detailsã€durationã€cost å­—æ®µ
4. æ¯ä¸¤ä¸ªéäº¤é€šæ´»åŠ¨ä¹‹é—´å¿…é¡»æ’å…¥ä¸€ä¸ªäº¤é€šæ´»åŠ¨
5. åæ ‡æ ¼å¼: [ç»åº¦, çº¬åº¦]ï¼Œä¾‹å¦‚ä¸œäº¬å¡”: [139.745438, 35.658581]
6. è¯·ä½¿ç”¨çœŸå®çš„åœ°ç†åæ ‡ï¼Œå¯ä»¥å‚è€ƒçŸ¥ååœ°æ ‡çš„å®é™…ä½ç½®
7. äº¤é€šè´¹ç”¨å¿…é¡»æ˜¯æ•°å­—ç±»å‹ï¼Œæ­¥è¡Œä¸º0ï¼Œåœ°é“2-5å…ƒï¼Œå…¬äº¤1-2å…ƒï¼Œå‡ºç§Ÿè½¦èµ·æ­¥ä»·13å…ƒ`;

  try {
    console.log('ğŸš€ å¼€å§‹è°ƒç”¨ AI ç”Ÿæˆè¡Œç¨‹...');
    const response = await callLLM(userPrompt, systemPrompt);

    // å°è¯•è§£æ JSON
    console.log('âœ… AIå“åº”æˆåŠŸï¼Œé•¿åº¦:', response.length);
    console.log('ğŸ“ ç”¨æˆ·æŒ‡å®šçš„æ™¯ç‚¹:', specificAttractions);
    console.log('ğŸ“„ AIå“åº”å‰300å­—ç¬¦:', response.substring(0, 300));

    // ç§»é™¤å¯èƒ½çš„ markdown ä»£ç å—æ ‡è®°
    let jsonStr = response.trim();
    if (jsonStr.startsWith('```json')) {
      jsonStr = jsonStr.replace(/^```json\s*/g, '').replace(/\s*```$/g, '');
    } else if (jsonStr.startsWith('```')) {
      jsonStr = jsonStr.replace(/^```\s*/g, '').replace(/\s*```$/g, '');
    }

    // æ£€æŸ¥JSONæ˜¯å¦å®Œæ•´(å¿…é¡»ä»¥}ç»“å°¾)
    if (!jsonStr.endsWith('}')) {
      console.warn('âš ï¸ JSON å¯èƒ½è¢«æˆªæ–­ï¼Œå°è¯•ä¿®å¤...');
      // å°è¯•æ‰¾åˆ°æœ€åä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡
      const lastBraceIndex = jsonStr.lastIndexOf('}');
      if (lastBraceIndex > 0) {
        jsonStr = jsonStr.substring(0, lastBraceIndex + 1);
        console.log('âœ… æˆªå–åˆ°æœ€åä¸€ä¸ªå®Œæ•´çš„ }');
      }
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯è¢«è½¬ä¹‰çš„ JSON å­—ç¬¦ä¸²ï¼ˆåŒ…å« \" è€Œä¸æ˜¯ "ï¼‰
    if ((jsonStr.startsWith('"') && jsonStr.endsWith('"')) || jsonStr.includes('\\"')) {
      console.log('æ£€æµ‹åˆ°è½¬ä¹‰çš„ JSON å­—ç¬¦ä¸²ï¼Œå°è¯•è§£ç ...');
      try {
        // å¦‚æœæ•´ä¸ªå­—ç¬¦ä¸²è¢«å¼•å·åŒ…è£¹ï¼Œå…ˆè§£æä¸€æ¬¡
        if (jsonStr.startsWith('"') && jsonStr.endsWith('"')) {
          const decoded = JSON.parse(jsonStr);
          if (typeof decoded === 'string') {
            jsonStr = decoded;
            console.log('âœ… JSON å­—ç¬¦ä¸²è§£ç æˆåŠŸ(æ–¹æ³•1)');
          }
        } else {
          // æ–¹æ³•2: ç›´æ¥æ›¿æ¢è½¬ä¹‰çš„å¼•å·å’Œåæ–œæ 
          const unescaped = jsonStr
            .replace(/\\"/g, '"')      // \" -> "
            .replace(/\\\\/g, '\\')    // \\ -> \
            .replace(/\\n/g, '\n')     // \\n -> \n
            .replace(/\\t/g, '\t');    // \\t -> \t

          // éªŒè¯æ˜¯å¦æ˜¯æœ‰æ•ˆçš„JSON
          try {
            JSON.parse(unescaped);
            jsonStr = unescaped;
            console.log('âœ… JSON å­—ç¬¦ä¸²åè½¬ä¹‰æˆåŠŸ(æ–¹æ³•2)');
          } catch {
            console.warn('åè½¬ä¹‰åä»ç„¶æ— æ•ˆï¼Œä¿æŒåŸæ ·');
          }
        }
      } catch (decodeError) {
        console.warn('JSON å­—ç¬¦ä¸²è§£ç å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²:', decodeError);
      }
    }

    // æå–JSONå¯¹è±¡(å¤„ç†å¯èƒ½çš„å‰åæ–‡æœ¬)
    if (!jsonStr.startsWith('{')) {
      const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        jsonStr = jsonMatch[0];
        console.log('âœ… æå–JSONå¯¹è±¡æˆåŠŸ');
      }
    }

    // å°è¯•ä¿®å¤å¸¸è§çš„ JSON æ ¼å¼é—®é¢˜
    try {
      const result = JSON.parse(jsonStr);

      // éªŒè¯æ˜¯å¦åŒ…å«ç”¨æˆ·æŒ‡å®šçš„æ™¯ç‚¹
      if (specificAttractions.length > 0) {
        const allActivities = result.itinerary?.flatMap((day: any) =>
          day.activities?.map((act: any) => act.name) || []
        ) || [];

        const missingAttractions = specificAttractions.filter(
          attraction => !allActivities.some((name: string) => name.includes(attraction))
        );

        if (missingAttractions.length > 0) {
          console.warn('âš ï¸ AI ç”Ÿæˆçš„è¡Œç¨‹ç¼ºå°‘ä»¥ä¸‹ç”¨æˆ·æŒ‡å®šçš„æ™¯ç‚¹:', missingAttractions);
          console.warn('è¡Œç¨‹ä¸­åŒ…å«çš„æ™¯ç‚¹:', allActivities);

          // åœ¨å»ºè®®ä¸­æ·»åŠ æç¤º
          const missingSuggestion = `\n\nâš ï¸ æ³¨æ„ï¼šè¡Œç¨‹ä¸­å¯èƒ½æœªåŒ…å«æ‚¨æŒ‡å®šçš„ä»¥ä¸‹æ™¯ç‚¹ï¼š${missingAttractions.join('ã€')}ã€‚æ‚¨å¯ä»¥è¦æ±‚æˆ‘é‡æ–°ç”ŸæˆåŒ…å«è¿™äº›æ™¯ç‚¹çš„è¡Œç¨‹ã€‚`;
          result.suggestions = (result.suggestions || '') + missingSuggestion;
        } else {
          console.log('âœ… æ‰€æœ‰ç”¨æˆ·æŒ‡å®šçš„æ™¯ç‚¹éƒ½å·²åŒ…å«åœ¨è¡Œç¨‹ä¸­');
        }
      }

      return {
        destination: result.destination || params.destination, // ä¼˜å…ˆä½¿ç”¨ AI è¿”å›çš„ç›®çš„åœ°ï¼Œå¦åˆ™ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ç›®çš„åœ°
        itinerary: result.itinerary || [],
        suggestions: result.suggestions || 'æš‚æ— å»ºè®®',
        budget: params.budget,
        travelers: params.travelers,
        preferences: params.preferences,
      };
    } catch (parseError) {
      console.warn('é¦–æ¬¡ JSON è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤...', parseError);

      // å°è¯•å¤šç§ä¿®å¤ç­–ç•¥
      let fixedStr = jsonStr;

      // 1. æå– JSON å¯¹è±¡ï¼ˆå…ˆåšè¿™ä¸€æ­¥ï¼Œé¿å…å¤„ç†å¤šä½™çš„æ–‡æœ¬ï¼‰
      const jsonMatch = fixedStr.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        fixedStr = jsonMatch[0];
      }

      // 2. æ£€æŸ¥å¹¶ä¿®å¤æœªé—­åˆçš„å­—ç¬¦ä¸²
      // å¦‚æœæœ‰ "Unterminated string" é”™è¯¯,é€šå¸¸æ˜¯å› ä¸ºå­—ç¬¦ä¸²ä¸­æœ‰æœªè½¬ä¹‰çš„å¼•å·æˆ–æ¢è¡Œ
      const errorMsg = parseError.message;
      if (errorMsg.includes('Unterminated string')) {
        console.log('æ£€æµ‹åˆ°æœªé—­åˆçš„å­—ç¬¦ä¸²ï¼Œå°è¯•ä¿®å¤...');

        // æ‰¾åˆ°é”™è¯¯ä½ç½®
        const posMatch = errorMsg.match(/position (\d+)/);
        if (posMatch) {
          const errorPos = parseInt(posMatch[1]);
          console.log('é”™è¯¯ä½ç½®:', errorPos);

          // æˆªå–åˆ°é”™è¯¯ä½ç½®ä¹‹å‰çš„æœ€åä¸€ä¸ªå®Œæ•´å¯¹è±¡
          const beforeError = fixedStr.substring(0, errorPos);
          const lastCompleteObject = beforeError.lastIndexOf('}');

          if (lastCompleteObject > 0) {
            // å°è¯•æ‰¾åˆ°åŒ…å«è¿™ä¸ª}çš„å®Œæ•´JSON
            let depth = 0;
            let startPos = -1;

            for (let i = 0; i <= lastCompleteObject; i++) {
              if (fixedStr[i] === '{') {
                if (depth === 0) startPos = i;
                depth++;
              } else if (fixedStr[i] === '}') {
                depth--;
                if (depth === 0 && i === lastCompleteObject) {
                  fixedStr = fixedStr.substring(startPos, i + 1);
                  console.log('âœ… æˆªå–åˆ°æœ€åä¸€ä¸ªå®Œæ•´çš„JSONå¯¹è±¡');
                  break;
                }
              }
            }
          }
        }
      }

      // 3. ä¿®å¤ JSON å­—ç¬¦ä¸²ä¸­çš„æ¢è¡Œç¬¦å’Œç‰¹æ®Šå­—ç¬¦
      // è¿™æ˜¯å…³é”®ä¿®å¤ï¼šæ­£ç¡®å¤„ç†å­—ç¬¦ä¸²å€¼ä¸­çš„æ¢è¡Œç¬¦
      fixedStr = fixedStr.replace(
        /"((?:[^"\\]|\\.)*)"/g,
        (_match, content) => {
          // æ›¿æ¢æœªè½¬ä¹‰çš„æ¢è¡Œç¬¦
          const fixed = content
            .replace(/\r\n/g, '\\n')  // Windows æ¢è¡Œ
            .replace(/\n/g, '\\n')    // Unix æ¢è¡Œ
            .replace(/\r/g, '\\n')    // Mac æ¢è¡Œ
            .replace(/\t/g, '\\t');   // åˆ¶è¡¨ç¬¦
          return `"${fixed}"`;
        }
      );

      // 4. ç§»é™¤æ§åˆ¶å­—ç¬¦ï¼ˆåœ¨å­—ç¬¦ä¸²å¤–éƒ¨çš„ï¼‰
      // eslint-disable-next-line no-control-regex
      fixedStr = fixedStr.replace(/[\u0000-\u0008\u000B-\u000C\u000E-\u001F\u007F-\u009F]/g, '');

      // 4. å°è¯•è§£æä¿®å¤åçš„ JSON
      try {
        const result = JSON.parse(fixedStr);
        console.log('âœ… JSON ä¿®å¤æˆåŠŸ');
        return {
          destination: result.destination || params.destination,
          itinerary: result.itinerary || [],
          suggestions: result.suggestions || 'æš‚æ— å»ºè®®',
          budget: params.budget,
          travelers: params.travelers,
          preferences: params.preferences,
        };
      } catch (secondError) {
        console.error('JSON ä¿®å¤å¤±è´¥:', secondError);
        console.error('åŸå§‹å“åº”å‰500å­—ç¬¦:', response.substring(0, 500));
        console.error('ä¿®å¤åçš„JSONå‰500å­—ç¬¦:', fixedStr.substring(0, 500));

        // æœ€åå°è¯•ï¼šä½¿ç”¨ eval (ä¸å®‰å…¨ï¼Œä½†ä½œä¸ºæœ€åæ‰‹æ®µ)
        try {
          // ä½¿ç”¨ Function æ„é€ å™¨ä»£æ›¿ evalï¼Œç¨å¾®å®‰å…¨ä¸€äº›
          const result = new Function('return ' + fixedStr)();
          console.log('âš ï¸ ä½¿ç”¨ Function æ„é€ å™¨è§£ææˆåŠŸï¼ˆä¸æ¨èï¼‰');
          return {
            destination: result.destination || params.destination,
            itinerary: result.itinerary || [],
            suggestions: result.suggestions || 'æš‚æ— å»ºè®®',
            budget: params.budget,
            travelers: params.travelers,
            preferences: params.preferences,
          };
        } catch {
          console.error('æ‰€æœ‰ä¿®å¤å°è¯•å‡å¤±è´¥');
          throw secondError;
        }
      }
    }
  } catch (error: any) {
    console.error('âŒ è§£æ AI å“åº”å¤±è´¥:', error);
    console.error('é”™è¯¯è¯¦æƒ…:', {
      message: error.message,
      stack: error.stack,
      jsonStrPreview: jsonStr?.substring(0, 500)
    });
    throw new Error(`AI ç”Ÿæˆçš„è¡Œç¨‹æ ¼å¼é”™è¯¯: ${error.message}ã€‚è¯·é‡è¯•æˆ–ç®€åŒ–éœ€æ±‚ã€‚`);
  }
};

/**
 * ä¼˜åŒ–ç°æœ‰è¡Œç¨‹
 */
export const optimizeItinerary = async (
  plan: TravelPlan,
  userFeedback: string
): Promise<{ itinerary: DayItinerary[]; explanation: string }> => {
  const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—…è¡Œè§„åˆ’åŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·åé¦ˆä¼˜åŒ–ç°æœ‰çš„æ—…è¡Œè®¡åˆ’ã€‚`;

  const userPrompt = `å½“å‰æ—…è¡Œè®¡åˆ’ï¼š
ç›®çš„åœ°ï¼š${plan.destination}
æ—¥æœŸï¼š${plan.start_date} è‡³ ${plan.end_date}
é¢„ç®—ï¼š${plan.budget} å…ƒ
äººæ•°ï¼š${plan.travelers} äºº

å½“å‰è¡Œç¨‹ï¼š
${JSON.stringify(plan.itinerary, null, 2)}

ç”¨æˆ·åé¦ˆï¼š${userFeedback}

è¯·æ ¹æ®ç”¨æˆ·åé¦ˆä¼˜åŒ–è¡Œç¨‹ï¼Œè¿”å› JSON æ ¼å¼ï¼š
{
  "itinerary": [...],
  "explanation": "ä¼˜åŒ–è¯´æ˜"
}`;

  try {
    const response = await callLLM(userPrompt, systemPrompt);
    let jsonStr = response.trim();
    if (jsonStr.startsWith('```json')) {
      jsonStr = jsonStr.replace(/```json\n?/g, '').replace(/```\n?$/g, '');
    } else if (jsonStr.startsWith('```')) {
      jsonStr = jsonStr.replace(/```\n?/g, '');
    }

    // å°è¯•è§£æ JSON
    try {
      const result = JSON.parse(jsonStr);
      return {
        itinerary: result.itinerary || plan.itinerary,
        explanation: result.explanation || 'å·²æ ¹æ®æ‚¨çš„åé¦ˆè¿›è¡Œä¼˜åŒ–',
      };
    } catch (parseError) {
      console.warn('JSON è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤...', parseError);

      // ä¿®å¤ç­–ç•¥
      let fixedStr = jsonStr;

      // 1. æå– JSON å¯¹è±¡
      const jsonMatch = fixedStr.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        fixedStr = jsonMatch[0];
      }

      // 2. ä¿®å¤å­—ç¬¦ä¸²ä¸­çš„æ¢è¡Œç¬¦
      fixedStr = fixedStr.replace(
        /"((?:[^"\\]|\\.)*)"/g,
        (_match, content) => {
          const fixed = content
            .replace(/\r\n/g, '\\n')
            .replace(/\n/g, '\\n')
            .replace(/\r/g, '\\n')
            .replace(/\t/g, '\\t');
          return `"${fixed}"`;
        }
      );

      // 3. ç§»é™¤æ§åˆ¶å­—ç¬¦
      // eslint-disable-next-line no-control-regex
      fixedStr = fixedStr.replace(/[\u0000-\u0008\u000B-\u000C\u000E-\u001F\u007F-\u009F]/g, '');

      try {
        const result = JSON.parse(fixedStr);
        console.log('âœ… JSON ä¿®å¤æˆåŠŸ');
        return {
          itinerary: result.itinerary || plan.itinerary,
          explanation: result.explanation || 'å·²æ ¹æ®æ‚¨çš„åé¦ˆè¿›è¡Œä¼˜åŒ–',
        };
      } catch (secondError) {
        console.error('JSON ä¿®å¤å¤±è´¥:', secondError);
        throw parseError;
      }
    }
  } catch (error) {
    console.error('ä¼˜åŒ–è¡Œç¨‹å¤±è´¥:', error);
    throw new Error('è¡Œç¨‹ä¼˜åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
};

/**
 * ç”Ÿæˆé¢„ç®—åˆ†æ
 */
export const analyzeBudget = async (params: {
  destination: string;
  days: number;
  totalBudget: number;
  travelers: number;
  preferences: string[];
  currentExpenses?: any[];
  startDate?: string;
  endDate?: string;
}): Promise<{
  health_score: number;
  summary: string;
  category_analysis: {
    category: string;
    category_name: string;
    spent: number;
    budget: number;
    percentage: number;
    status: 'good' | 'warning' | 'danger';
    suggestion: string;
  }[];
  warnings: string[];
  suggestions: string[];
  daily_average: number;
  remaining_budget: number;
  predicted_total: number;
  days_passed: number;
  days_remaining: number;
  recommended_daily_budget: number;
}> => {
  // è®¡ç®—å½“å‰è´¹ç”¨ç»Ÿè®¡
  const totalSpent = params.currentExpenses?.reduce((sum, exp) => sum + exp.amount, 0) || 0;
  const remainingBudget = params.totalBudget - totalSpent;

  // è®¡ç®—å·²è¿‡å¤©æ•°å’Œå‰©ä½™å¤©æ•°
  const today = new Date();
  const startDate = params.startDate ? new Date(params.startDate) : today;
  const endDate = params.endDate ? new Date(params.endDate) : new Date(today.getTime() + params.days * 24 * 60 * 60 * 1000);
  const daysPassed = Math.max(1, Math.ceil((today.getTime() - startDate.getTime()) / (24 * 60 * 60 * 1000)));
  const daysRemaining = Math.max(1, Math.ceil((endDate.getTime() - today.getTime()) / (24 * 60 * 60 * 1000)));
  const dailyAverage = totalSpent / daysPassed;

  // æŒ‰ç±»åˆ«ç»Ÿè®¡è´¹ç”¨
  const categoryStats: Record<string, number> = {};
  params.currentExpenses?.forEach(exp => {
    categoryStats[exp.category] = (categoryStats[exp.category] || 0) + exp.amount;
  });

  const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—…è¡Œé¢„ç®—åˆ†æå¸ˆï¼Œæ“…é•¿ï¼š
1. åˆ†ææ—…è¡Œè´¹ç”¨æ”¯å‡ºæƒ…å†µï¼Œç»™å‡ºç²¾å‡†çš„é¢„ç®—å¥åº·åº¦è¯„åˆ†
2. è¯†åˆ«è¶…æ”¯é£é™©ï¼Œæä¾›åŠæ—¶é¢„è­¦
3. æ ¹æ®ç›®çš„åœ°æ¶ˆè´¹æ°´å¹³å’Œç”¨æˆ·åå¥½ï¼Œç»™å‡ºä¸ªæ€§åŒ–å»ºè®®
4. æä¾›å®ç”¨çš„çœé’±æŠ€å·§å’Œæ›¿ä»£æ–¹æ¡ˆ

è¯·åŠ¡å¿…è¿”å›ä¸¥æ ¼çš„ JSON æ ¼å¼ï¼Œä¸è¦æ·»åŠ ä»»ä½•é¢å¤–çš„æ–‡å­—è¯´æ˜ã€‚`;

  const userPrompt = `è¯·åˆ†æä»¥ä¸‹æ—…è¡Œçš„é¢„ç®—æ‰§è¡Œæƒ…å†µï¼š

ğŸ“ **æ—…è¡Œä¿¡æ¯**
- ç›®çš„åœ°ï¼š${params.destination}
- æ€»å¤©æ•°ï¼š${params.days} å¤©
- å·²è¿‡å¤©æ•°ï¼š${daysPassed} å¤©
- å‰©ä½™å¤©æ•°ï¼š${daysRemaining} å¤©
- æ€»é¢„ç®—ï¼šÂ¥${params.totalBudget}
- äººæ•°ï¼š${params.travelers} äºº
- åå¥½ï¼š${params.preferences.join('ã€') || 'æ— '}

ğŸ’° **å½“å‰æ”¯å‡ºæƒ…å†µ**
- å·²èŠ±è´¹ï¼šÂ¥${totalSpent.toFixed(2)}
- å‰©ä½™é¢„ç®—ï¼šÂ¥${remainingBudget.toFixed(2)}
- æ—¥å‡æ”¯å‡ºï¼šÂ¥${dailyAverage.toFixed(2)}
- é¢„ç®—æ‰§è¡Œç‡ï¼š${((totalSpent / params.totalBudget) * 100).toFixed(1)}%

ğŸ“Š **å„ç±»åˆ«æ”¯å‡ºæ˜ç»†**
${Object.entries(categoryStats).map(([cat, amount]) => {
  const categoryNames: Record<string, string> = {
    transportation: 'äº¤é€š',
    accommodation: 'ä½å®¿',
    food: 'é¤é¥®',
    attraction: 'æ™¯ç‚¹',
    shopping: 'è´­ç‰©',
    other: 'å…¶ä»–'
  };
  return `- ${categoryNames[cat] || cat}ï¼šÂ¥${amount.toFixed(2)}`;
}).join('\n') || '- æš‚æ— è´¹ç”¨è®°å½•'}

ğŸ¯ **åˆ†æè¦æ±‚**
1. **å¥åº·åº¦è¯„åˆ† (health_score)**ï¼š0-100åˆ†ï¼Œç»¼åˆè€ƒè™‘é¢„ç®—æ‰§è¡Œç‡ã€å„ç±»åˆ«å‡è¡¡åº¦ã€è¶…æ”¯é£é™©
   - 90-100åˆ†ï¼šä¼˜ç§€ï¼Œé¢„ç®—æ§åˆ¶è‰¯å¥½
   - 70-89åˆ†ï¼šè‰¯å¥½ï¼ŒåŸºæœ¬ç¬¦åˆé¢„æœŸ
   - 50-69åˆ†ï¼šè­¦å‘Šï¼Œå­˜åœ¨è¶…æ”¯é£é™©
   - 0-49åˆ†ï¼šå±é™©ï¼Œä¸¥é‡è¶…æ”¯

2. **ç±»åˆ«åˆ†æ (category_analysis)**ï¼šåˆ†ææ¯ä¸ªæœ‰æ”¯å‡ºçš„ç±»åˆ«ï¼ŒåŒ…æ‹¬ï¼š
   - å·²èŠ±è´¹é‡‘é¢
   - å»ºè®®é¢„ç®—ï¼ˆåŸºäºç›®çš„åœ°æ¶ˆè´¹æ°´å¹³å’Œå‰©ä½™å¤©æ•°ï¼‰
   - æ”¯å‡ºå æ¯”
   - çŠ¶æ€è¯„ä¼°ï¼ˆgood/warning/dangerï¼‰
   - å…·ä½“å»ºè®®

3. **é¢„è­¦ä¿¡æ¯ (warnings)**ï¼š
   - è¶…è¿‡é¢„ç®—80%çš„ç±»åˆ«
   - æ—¥å‡æ”¯å‡ºè¿‡é«˜
   - é¢„è®¡æ€»è´¹ç”¨è¶…é¢„ç®—

4. **ä¼˜åŒ–å»ºè®® (suggestions)**ï¼š
   - å‰©ä½™å¤©æ•°çš„æ¯æ—¥é¢„ç®—å»ºè®®
   - å„ç±»åˆ«çš„èŠ‚çœæ–¹æ¡ˆ
   - åŸºäºåå¥½çš„ä¸ªæ€§åŒ–å»ºè®®

5. **é¢„æµ‹åˆ†æ**ï¼š
   - æŒ‰å½“å‰æ¶ˆè´¹è¶‹åŠ¿é¢„æµ‹æ€»è´¹ç”¨
   - å»ºè®®çš„æ¯æ—¥é¢„ç®—

è¯·ä¸¥æ ¼è¿”å›ä»¥ä¸‹ JSON æ ¼å¼ï¼ˆä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ï¼‰ï¼š
{
  "health_score": 75,
  "summary": "ç®€çŸ­æ€»ç»“ï¼ˆä¸€å¥è¯ï¼‰",
  "category_analysis": [
    {
      "category": "food",
      "category_name": "é¤é¥®",
      "spent": 1200,
      "budget": 1500,
      "percentage": 80,
      "status": "warning",
      "suggestion": "å…·ä½“å»ºè®®"
    }
  ],
  "warnings": ["é¢„è­¦ä¿¡æ¯1", "é¢„è­¦ä¿¡æ¯2"],
  "suggestions": ["å»ºè®®1", "å»ºè®®2", "å»ºè®®3"],
  "daily_average": ${dailyAverage.toFixed(2)},
  "remaining_budget": ${remainingBudget.toFixed(2)},
  "predicted_total": 9500,
  "days_passed": ${daysPassed},
  "days_remaining": ${daysRemaining},
  "recommended_daily_budget": 500
}

ç±»åˆ«ä»£ç ï¼štransportation(äº¤é€š)ã€accommodation(ä½å®¿)ã€food(é¤é¥®)ã€attraction(æ™¯ç‚¹)ã€shopping(è´­ç‰©)ã€other(å…¶ä»–)`;

  try {
    console.log('ğŸ¤– å‘é€é¢„ç®—åˆ†æè¯·æ±‚...');
    const response = await callLLM(userPrompt, systemPrompt);
    console.log('ğŸ“¥ æ”¶åˆ° AI å“åº”:', response.substring(0, 200) + '...');

    let jsonStr = response.trim();
    if (jsonStr.startsWith('```json')) {
      jsonStr = jsonStr.replace(/```json\n?/g, '').replace(/```\n?$/g, '');
    } else if (jsonStr.startsWith('```')) {
      jsonStr = jsonStr.replace(/```\n?/g, '');
    }

    // å°è¯•è§£æ JSON
    try {
      const result = JSON.parse(jsonStr);
      console.log('âœ… JSON è§£ææˆåŠŸ');

      // è¿”å›å®Œæ•´çš„åˆ†æç»“æœ
      return {
        health_score: result.health_score || 50,
        summary: result.summary || 'é¢„ç®—åˆ†æå®Œæˆ',
        category_analysis: result.category_analysis || [],
        warnings: result.warnings || [],
        suggestions: result.suggestions || [],
        daily_average: dailyAverage,
        remaining_budget: remainingBudget,
        predicted_total: result.predicted_total || totalSpent,
        days_passed: daysPassed,
        days_remaining: daysRemaining,
        recommended_daily_budget: result.recommended_daily_budget || (remainingBudget / daysRemaining),
      };
    } catch (parseError) {
      console.warn('âš ï¸ JSON è§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤...', parseError);
      console.log('åŸå§‹å“åº”:', jsonStr);

      // ä¿®å¤ç­–ç•¥
      let fixedStr = jsonStr;

      // 1. æå– JSON å¯¹è±¡
      const jsonMatch = fixedStr.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        fixedStr = jsonMatch[0];
      }

      // 2. ä¿®å¤å­—ç¬¦ä¸²ä¸­çš„æ¢è¡Œç¬¦
      fixedStr = fixedStr.replace(
        /"((?:[^"\\]|\\.)*)"/g,
        (_match, content) => {
          const fixed = content
            .replace(/\r\n/g, '\\n')
            .replace(/\n/g, '\\n')
            .replace(/\r/g, '\\n')
            .replace(/\t/g, '\\t');
          return `"${fixed}"`;
        }
      );

      // 3. ç§»é™¤æ§åˆ¶å­—ç¬¦
      // eslint-disable-next-line no-control-regex
      fixedStr = fixedStr.replace(/[\u0000-\u0008\u000B-\u000C\u000E-\u001F\u007F-\u009F]/g, '');

      try {
        const result = JSON.parse(fixedStr);
        console.log('âœ… JSON ä¿®å¤æˆåŠŸ');

        return {
          health_score: result.health_score || 50,
          summary: result.summary || 'é¢„ç®—åˆ†æå®Œæˆ',
          category_analysis: result.category_analysis || [],
          warnings: result.warnings || [],
          suggestions: result.suggestions || [],
          daily_average: dailyAverage,
          remaining_budget: remainingBudget,
          predicted_total: result.predicted_total || totalSpent,
          days_passed: daysPassed,
          days_remaining: daysRemaining,
          recommended_daily_budget: result.recommended_daily_budget || (remainingBudget / daysRemaining),
        };
      } catch (secondError) {
        console.error('âŒ JSON ä¿®å¤å¤±è´¥:', secondError);
        console.error('ä¿®å¤åçš„å­—ç¬¦ä¸²:', fixedStr);
        throw new Error('AI è¿”å›æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•');
      }
    }
  } catch (error: any) {
    console.error('âŒ é¢„ç®—åˆ†æå¤±è´¥:', error);
    throw new Error(error.message || 'é¢„ç®—åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•');
  }
};

/**
 * AI å¯¹è¯ï¼ˆé€šç”¨ï¼‰
 */
export const chatWithAI = async (
  message: string,
  context?: string
): Promise<string> => {
  const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—…è¡Œè§„åˆ’åŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”å…³äºæ—…è¡Œçš„å„ç§é—®é¢˜ã€‚${context ? `\n\nå½“å‰ä¸Šä¸‹æ–‡ï¼š${context}` : ''}`;

  return callLLM(message, systemPrompt);
};

