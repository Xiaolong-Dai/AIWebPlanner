# AI 服务 404 错误修复说明

## 🐛 问题描述

用户在测试 AI 对话功能时遇到错误:

```
抱歉,AI服务暂时无法响应。
请检查网络连接和 AI 服务配置
请检查配置后重试。
测试内容:AI 对话功能
测试失败
AI 服务调用失败: Request failed with status code 404
```

---

## 🔍 问题分析

### 1. 后端日志显示

```
[2025-10-29T13:42:28.133Z] 代理请求到阿里云百炼: https://bailian.aliyun.com/v1/api/completions
[2025-10-29T13:42:28.553Z] 阿里云API错误: { status: 404, statusText: 'Not Found', error: {} }
```

### 2. 根本原因

**用户配置的 API Endpoint 不正确**:
- ❌ 错误: `https://bailian.aliyun.com/v1/api/completions`
- ✅ 正确: `https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation`

**说明**:
- `bailian.aliyun.com` 是**控制台网址**,不是 API endpoint
- 实际的 API 服务在 `dashscope.aliyuncs.com` 域名下
- 这是阿里云 DashScope API 的标准地址

---

## ✅ 解决方案

### 修改 1: 优化设置页面提示

**文件**: `frontend/src/pages/Settings.tsx`

**修改内容**:

1. **API Key 字段**:
   - 添加 tooltip: "在阿里云百炼控制台获取 API Key"
   - 修改 placeholder: `sk-xxxxxxxxxxxxxxxx`

2. **API Endpoint 字段**:
   - 添加 tooltip: "使用 DashScope API endpoint"
   - 添加详细说明 (extra):
     ```
     ✅ 正确示例: https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
     💡 获取方式: [查看文档]
     ```

**代码变更**:

```typescript
// 修改前
<Form.Item
  label="API Key"
  name="llm_api_key"
  rules={[{ required: true, message: '请输入 LLM API Key' }]}
>
  <Input.Password placeholder="your-llm-api-key" prefix={<KeyOutlined />} size="large" />
</Form.Item>

<Form.Item
  label="API Endpoint"
  name="llm_endpoint"
  rules={[{ required: true, message: '请输入 API Endpoint' }]}
>
  <Input
    placeholder="https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"
    prefix={<KeyOutlined />}
    size="large"
  />
</Form.Item>

// 修改后
<Form.Item
  label="API Key"
  name="llm_api_key"
  rules={[{ required: true, message: '请输入 LLM API Key' }]}
  tooltip="在阿里云百炼控制台获取 API Key"
>
  <Input.Password placeholder="sk-xxxxxxxxxxxxxxxx" prefix={<KeyOutlined />} size="large" />
</Form.Item>

<Form.Item
  label="API Endpoint"
  name="llm_endpoint"
  rules={[{ required: true, message: '请输入 API Endpoint' }]}
  tooltip="使用 DashScope API endpoint"
  extra={
    <div style={{ marginTop: 8, color: '#666', fontSize: 12 }}>
      <div>✅ 正确示例: https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation</div>
      <div style={{ marginTop: 4 }}>
        💡 获取方式: 
        <a href="https://help.aliyun.com/zh/model-studio/getting-started/first-api-call-to-qwen" target="_blank" rel="noopener noreferrer" style={{ marginLeft: 4 }}>
          查看文档
        </a>
      </div>
    </div>
  }
>
  <Input
    placeholder="https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"
    prefix={<KeyOutlined />}
    size="large"
  />
</Form.Item>
```

### 修改 2: 创建配置指南文档

**文件**: `阿里云百炼API配置指南.md`

**内容包括**:
1. 问题说明
2. 正确的配置方式
3. 获取 API Key 和 Endpoint 的详细步骤
4. 在应用中配置的方法
5. 常见问题解答
6. 验证配置的方法

---

## 🚀 使用指南

### 1. 刷新浏览器

访问 http://localhost:3000 并刷新页面

### 2. 打开设置页面

点击右上角的 **设置图标** ⚙️

### 3. 修改 API Endpoint

将 Endpoint 改为:
```
https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
```

### 4. 确认 API Key

确保 API Key 格式正确:
```
sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 5. 保存配置

点击 **"保存配置"** 按钮

### 6. 测试

点击 **"测试 AI 对话"** 按钮

**预期结果**:
```
✅ 测试成功
AI 服务配置正确
```

---

## 📝 正确的配置示例

```json
{
  "llm_api_key": "sk-abc123def456ghi789jkl",
  "llm_endpoint": "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"
}
```

---

## ❌ 常见错误配置

### 错误 1: 使用控制台地址

```
❌ https://bailian.aliyun.com/v1/api/completions
❌ https://bailian.console.aliyun.com/...
```

**原因**: 这些是控制台网址,不是 API endpoint

### 错误 2: 使用错误的路径

```
❌ https://dashscope.aliyuncs.com/api/v1/completions
❌ https://dashscope.aliyuncs.com/v1/chat/completions
```

**原因**: 路径不正确,应该使用完整的服务路径

### 错误 3: API Key 格式错误

```
❌ your-llm-api-key
❌ abc123
```

**原因**: API Key 应该以 `sk-` 开头

---

## 🔍 如何验证配置

### 方法 1: 在应用中测试

1. 打开设置页面
2. 填写 API Key 和 Endpoint
3. 点击 **"测试 AI 对话"**
4. 查看测试结果

### 方法 2: 查看后端日志

```powershell
docker-compose logs backend -f
```

**正确的日志**:
```
[时间] 代理请求到阿里云百炼: https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
[时间] 阿里云API响应成功
```

**错误的日志**:
```
[时间] 阿里云API错误: { status: 404, statusText: 'Not Found', error: {} }
```

### 方法 3: 使用 curl 测试

```bash
curl -X POST \
  https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "model": "qwen-plus",
    "input": {
      "messages": [
        {
          "role": "user",
          "content": "你好"
        }
      ]
    },
    "parameters": {
      "result_format": "message"
    }
  }'
```

---

## 📚 相关文档

### 官方文档
- **阿里云百炼控制台**: https://bailian.console.aliyun.com
- **DashScope API 文档**: https://help.aliyun.com/zh/dashscope/developer-reference/api-details
- **快速开始**: https://help.aliyun.com/zh/model-studio/getting-started/first-api-call-to-qwen

### 项目文档
- **阿里云百炼API配置指南.md** - 详细配置说明
- **部署成功_Docker.md** - Docker 部署指南
- **README.md** - 项目总览

---

## 🎯 总结

### 问题
- 用户配置了错误的 API Endpoint
- 使用了控制台地址而不是 API 地址

### 解决
1. ✅ 优化设置页面,添加详细提示和示例
2. ✅ 创建配置指南文档
3. ✅ 重新构建前端应用

### 结果
- 用户可以看到正确的配置示例
- 有详细的文档指导
- 可以正确配置并使用 AI 服务

---

**修复时间**: 2025-10-29  
**修复文件**: 
- `frontend/src/pages/Settings.tsx`
- `阿里云百炼API配置指南.md`
- `AI服务404错误修复说明.md` (本文档)

**状态**: ✅ 已修复并部署

